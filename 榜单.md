## 🤖 Assistant

没问题，你说得对，将确认好的核心逻辑正式归档到技术文档中是至关重要的一步。这能确保我们未来的开发工作都有一个统一、清晰的参考标准。

我已经将我们刚才确认的“各权限显示逻辑”详细地补充到了技术需求文档中，主要更新了 **“2. 核心功能点”** 部分，并对后端的实现细节做了一点补充说明，使其更加严谨。

以下是包含了这部分更新的 **完整版技术需求与开发方案**。

---

### **技术需求与开发方案：动态排名模块 (完整版 v2)**

#### **1. 项目/功能概述 (Overview)**

在现有的数据分析仪表盘中，新增一个“业绩排行榜”模块。该模块能够根据用户在顶部指标卡片区选择的任意指标（如销售额、任务完成率等），动态展示相关人员或团队的Top 10排名。同时，它能精准地响应全局筛选条件，并为不同权限的用户提供相适应的排名视图。

#### **2. 核心功能点 (Core Features)**

* **动态指标排名：** 排名内容与上方 `CardGrid` 模块联动。用户点击不同指标卡片，下方的排行榜会实时更新，以该指标进行排名。
* **Top 10 展示：** 默认情况下，排行榜展示前10名的数据。
* **个人定位显示：** 如果当前登录用户或筛选的特定用户未进入前10名，将在列表底部额外显示其本人的排名、姓名和数据，提供“我的排名”视图。
* **响应全局筛选：** 排行榜的数据范围严格遵守顶部 `FilterBar` 的所有筛选条件（时间范围、小组、角色、特定用户等）。
* **界面设计：** 采用列表形式，置于“趋势分析”图表下方的新卡片中。每项排名需展示：**排名、用户头像、姓名、指标数值**。
* **权限适配与视图隔离 (Permissions & View Scoping):** 这是本模块的核心逻辑，不同角色的用户将看到不同的内容。
 * **超级管理员 (Super Admin):**
 * **数据范围:** 全局，可查看公司所有人。
 * **筛选能力:** 完全控制，可使用所有筛选器。
 * **排行榜视图:**
 * 默认显示 **全公司** 范围内 Top 10 排名。
 * 可根据其选择的筛选条件（如特定小组），查看对应范围内的排名。
 * 筛选特定用户时，能保证该用户排名数据显示在榜单上。
 * **管理员 (Group Admin):**
 * **数据范围:** 自动限定在 **自己所属的小组** 内。
 * **筛选能力:** 可筛选时间、角色及自己组内的特定成员，但无法选择其他小组。
 * **排行榜视图:** 始终显示 **自己小组内部成员** 的 Top 10 排名。
 * **普通用户 (Regular User):**
 * **数据范围:** 自动限定在 **自己所属的小组** 内。
 * **筛选能力:** 基本锁定，主要可更改时间范围。用户和小组选择器对他们禁用或隐藏。
 * **排行榜视图:** 始终显示 **自己小组的 Top 10 排名**，并在底部 **自动附带“我的排名”信息**。

#### **3. 技术规格 (Technical Specifications)**

##### **前端 (Frontend)**

* **新增组件 (New Component):**
 * `RankingList.vue`: 一个全新的、可复用的排行榜组件。
* **组件通信 (Component Interaction):**
 * `AnalyticsDashboard.vue` (父) 向 `RankingList.vue` (子) 传递 `metricKey` 和 `filterParams` 两个 props。
* **用户流程 (User Flow):**
 1. 页面加载，`RankingList` 根据初始 `props` 获取并显示排名。
 2. 用户点击指标卡片或更改筛选条件，父组件的 `activeMetricKey` 或 `filterParams` 状态更新。
 3. `RankingList` 组件通过 `watch` 侦测到 `props` 变化，携带新参数重新向后端请求数据并更新视图。

##### **后端 (Backend)**

* **API 接口 (API Endpoint):**
 * **功能描述:** 根据指定的指标和筛选条件，并结合当前用户的权限，返回对应的排名数据。
 * **请求方法:** `GET`
 * **URL 路径:** `/api/analytics/ranking`
 * **请求参数 (Query Parameters):**
 * `metric_key` (string, **必需**): 指标键名, e.g., `'period_sales_amount'`。
 * `start_date`, `end_date`, `group_id`, `role_scope`, `user_id`: 均为可选的筛选参数。
 * **权限与数据范围处理 (Security & Scoping Note):**
 * 后端 **必须** 通过请求的认证信息（如 JWT Token）来识别当前用户的角色和所属小组ID。
 * 后端逻辑需要 **强制覆盖** 请求参数以保证数据安全：
 * 如果用户是 **管理员**，则忽略请求中的 `group_id`，强制使用该管理员自己的小组ID进行查询。
 * 如果用户是 **普通用户**，则忽略 `group_id` 和 `user_id`，强制使用该用户自己的小组ID，并自动将其 `user_id` 作为需要特别关注的用户。
* **响应数据格式 (JSON Response):**
 * **成功响应 (200 OK):**
 ```json
 {
 "top_10": [
 { "rank": 1, "user_id": 101, "name": "张三", "avatar": "...", "value": 520000, "formatted_value": "¥520,000.00" },
 { "rank": 2, "user_id": 105, "name": "李四", "avatar": "...", "value": 485000, "formatted_value": "¥485,000.00" }
 ],
 "current_user_rank": { // 仅当被关注用户（自己或筛选的）不在Top10时返回
 "rank": 25, "user_id": 120, "name": "王五", "avatar": "...", "value": 150000, "formatted_value": "¥150,000.00"
 }
 }
 ```

#### **4. 技术栈建议 (Tech Stack Suggestion)**

* **前端:** Vue 3, Element Plus
* **后端:** 你现有的技术栈 (Python/Node.js/Java/Go 等)

#### **5. 开发步骤建议 (Development Steps)**

**第一阶段：后端开发 (Backend First)**

1. **创建API路由：** 创建 `GET /api/analytics/ranking` 路由。
2. **实现权限控制与数据范围限定：** 在API的入口处，编写一个中间件或装饰器，用于解析用户Token，获取用户角色和小组ID，并根据我们定义好的权限规则来调整后续查询的范围。
3. **实现核心动态排名逻辑：** 编写一个根据 `metric_key` 查询不同业务数据、进行聚合、排序并生成排名的服务函数。
4. **构建响应数据：** 获取排序后的列表，按规定格式组装 `top_10` 和 `current_user_rank` 对象。
5. **充分测试API：** 使用Postman等工具，分别使用超管、管理员、普通用户的Token进行测试，确保在各种筛选条件下，数据范围和排名结果都符合权限逻辑。

**第二阶段：前端开发 (Frontend)**

6. **创建组件文件：** 新建 `src/components/RankingList.vue`。
7. **编写组件骨架与数据获取逻辑：** 在组件中定义 `props`，设置 `ref` 状态，并编写 `fetchRankingData` 函数和 `watch` 监听器。
8. **渲染排名列表：** 使用 `v-for` 渲染 `top_10` 列表，并使用 `v-if` 条件渲染底部的 `current_user_rank` 模块。
9. **集成到主页面：** 在 `AnalyticsDashboard.vue` 中引入并使用 `<RankingList :metricKey="activeMetricKey" :filterParams="filterParams" />`。
10. **样式微调：** 调整 `RankingList.vue` 的CSS样式，使其美观。

---

这份更新后的文档现在更加完整和严谨了。你可以随时把它作为你开发过程中的“唯一真实来源 (Single Source of Truth)”。接下来准备从哪一步开始呢？
