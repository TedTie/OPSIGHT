## 🤖 Assistant

感谢您的清晰回复！这些信息非常关键，它帮助我将初步的想法精炼成了最终的、完全符合您期望的技术方案。

现在，我已经将您的确认和选择（如布局、交互方式、数据定义）完全融入到这份最终的技术文档中。这不仅仅是一份计划，而是一份您可以直接拿来指导开发的蓝图。

---

### **最终版：结构化技术需求文档**

#### **1. 项目/功能概述 (Overview)**

重构数据分析系统，打造一个多角色、权限隔离的**分析仪表盘 (Analytics Dashboard)**。该平台将以模块化数据卡片的形式，为不同身份的用户（CC, SS, LP）预设并展示其角色专属的核心业务指标。用户可通过点击卡片，在下方统一的趋势模块中查看该指标的深度趋势。系统集成了基于原始数据的双智能体（个人/团队）AI洞察功能。同时，将原 `AdminMetrics.vue` 升级为一个功能更全面的**指标管理后台 (`MetricsAdmin.vue`)**，用于设置月度目标和管理系统中的所有可用指标。

#### **2. 核心功能点 (Core Features)**

* **角色权限 (已确认):** 超管、管理员、普通用户的三级权限体系保持不变。
* **统一筛选:** 顶置全局筛选器，所有数据模块随筛选条件联动更新。
* **角色化数据卡片 (已确认):**
 * 不同身份（CC, SS, LP）的用户登录后，自动看到一组为他们角色**预设好**的、不同的数据卡片。
 * 提供固定核心指标卡片（如：任务完成率、期间销售总额）和角色个性化指标卡片。
* **期间数据定义 (已确认):** 关键指标（如销售额）的计算周期将严格遵循用户在筛选器中选择的时间范围（当日、本周、自定义等）。
* **联动趋势分析 (已确认 - 方案B):**
 * 页面下方设有一个**统一的图表区域**。
 * 用户点击上方的任何一张数据卡片，下方的图表区域会立即更新，显示该卡片对应指标的时间序列趋势图。
* **深度 AI 洞察 (已确认):**
 * **分析原始数据:** 点击AI按钮时，后端将查询构成指标的**原始详细记录**（格式化为JSON），并将其提供给AI模型进行深度分析。
 * **智能体自动切换:** 筛选到具体个人时使用“个人智能体”，否则一律使用“团队智能体”。
* **升级版指标管理后台 (`MetricsAdmin.vue` - 已确认并扩展):**
 * **月度目标设置:** 提供简洁的表单，供超级管理员设置月度总销售目标。
 * **指标库管理:** 新增一个管理模块，允许超级管理员查看系统内所有可用的数据指标，并能控制每个指标是否**“启用”或“禁用”**。

#### **3. 技术规格 (Technical Specifications)**

##### **前端 (Frontend)**

* **页面/组件 (Pages/Components):**
 * **`AnalyticsDashboard.vue` (新):**
 * **职责:** 页面主容器。管理全局筛选条件的状态、当前被激活用于趋势图的 `activeMetricKey` 状态。
 * **交互:** 监听 `FilterBar` 的变化，重新调用API获取数据。监听 `CardGrid` 中卡片的点击事件，更新 `activeMetricKey` 并传递给 `TrendChartModule`。
 * **`FilterBar.vue` (新):** 筛选栏组件，根据用户权限动态渲染筛选控件。
 * **`DataCard.vue` (新):**
 * **Props:** `title` (标题), `value` (值), `unit` (单位), `metricKey` (唯一标识), `isActive` (是否被选中用于趋势图)。
 * **Events:** `@click`: 点击时触发，向父组件冒泡 `metricKey`。
 * **`CardGrid.vue` (新):** 负责渲染数据卡片网格。它会接收从后端获取的卡片数据和配置。
 * **`TrendChartModule.vue` (新):**
 * **Props:** `metricKey` (当前要展示的指标Key)。
 * **交互:** 监听 `metricKey` prop 的变化。当 `metricKey` 变化时，根据全局筛选条件向后端 `GET /api/analytics/trend` 请求新数据并重绘ECharts图表。
 * **`MetricsAdmin.vue` (新，替代 `AdminMetrics.vue`):**
 * **UI:** 使用标签页 (Tabs) 分为两个部分："月度目标设置" 和 "指标库管理"。
 * "月度目标设置" 是一个简单表单。
 * "指标库管理" 是一个带有“启用/禁用”开关的表格。

##### **后端 (Backend)**

* **API 接口 (API Endpoints):**

| 方法 | URL | 用途 | 请求数据 | 响应数据 (JSON) |
| :--- | :--- | :--- | :--- | :--- |
| **GET** | `/api/analytics/summary` | 获取仪表盘所有卡片的汇总数据 | `start_date`, `end_date`, `group_id?`, `identity?`, `user_id?` | `{ "task_completion_rate": 0.85, "period_sales_amount": 250000, ... }` |
| **GET** | `/api/analytics/trend` | 获取单个指标的趋势数据 | `start_date`, `end_date`, `metric_key`, `group_id?`, `...` | `{ "series": [ { "date": "...", "value": ... } ] }` |
| **POST** | `/api/analytics/ai-insight` | 请求 AI 洞察 | `Body: { ..., "metric_key", "agent_type": "personal" | "team", ...}` | `{ "insight": "..." }` |
| **GET** | `/api/goals/monthly` | 获取指定月份的目标 | `year`, `month` | `{ "sales_total_target": 500000, ... }` |
| **POST**| `/api/goals/monthly` | 创建/更新月度目标 | `Body: { "year", "month", "sales_total_target": ... }` | `{ "success": true }` |
| **GET** | `/api/admin/metrics` | **(新)** 获取所有指标定义 | (分页/筛选) | `[{ "id", "key", "name", "is_active": true }, ...]` |
| **PUT** | `/api/admin/metrics/:id` | **(新)** 更新指标定义（如启用/禁用） | `Body: { "is_active": false }` | `{ "success": true }` |

* **数据模型 (Data Models):**
 * **`MonthlyGoal` (不变):** 用于存储月度目标值。
 * **`MetricDefinition` (新模型):**
 * **用途:** 建立一个系统级的“指标库”，让指标的管理不再是硬编码，而是数据驱动。
 * **字段:**
 * `id`: 主键
 * `key`: String (唯一键, e.g., "period_sales_amount")
 * `name`: String (显示名称, e.g., "期间销售总额")
 * `description`: Text (指标的详细说明)
 * `is_active`: Boolean (总开关，控制该指标是否在整个系统中可用)
 * `default_roles`: Array[String] (该指标默认显示给哪些角色, e.g., `["CC", "SS"]`)
 * `created_at`, `updated_at`

#### **4. 技术栈建议 (Tech Stack Suggestion)**

（保持不变）
* **前端:** Vue 3 + Element Plus + ECharts
* **后端:** Python + FastAPI (强烈推荐，对类型提示和自动文档生成非常友好)
* **数据库:** PostgreSQL 或 MySQL
* **AI:** OpenAI API

#### **5. 开发步骤建议 (Development Steps)**

这是您的行动清单，我们从最独立、最能快速见效的部分开始。

1. **后端基础重构与指标库建立 (第1-2天):**
 * [ ] **数据库:** 在后端项目中，创建 `MetricDefinition` 和 `MonthlyGoal` 的数据库模型，并执行数据库迁移。
 * [ ] **API:** 开发 `GET /api/admin/metrics` 和 `PUT /api/admin/metrics/:id` 接口，用于管理指标库。
 * [ ] **API:** 开发 `GET /api/goals/monthly` 和 `POST /api/goals/monthly` 接口，用于管理月度目标值。
 * **数据填充:** 手动或通过脚本，将您需要的所有指标（任务完成率、期间销售额等）预先录入到 `metric_definition` 表中。

2. **新版指标管理后台开发 (第3天):**
 * [ ] **(前端)** 创建全新的 `MetricsAdmin.vue` 文件。
 * [ ] **UI:** 在页面中创建两个标签页：“月度目标设置”和“指标库管理”。
 * [ ] **功能:** 对接上一步开发的4个API，完成月度目标的设置功能和指标库的启用/禁用功能。
 * **成就:** 至此，您已经可以用一个全新的、功能更强大的页面彻底替换掉旧的 `AdminMetrics.vue`。

3. **核心数据接口与权限逻辑 (第4-6天):**
 * [ ] **(后端)** 重点开发 `GET /api/analytics/summary` 接口。
 * [ ] **权限:** 接口内部必须严格校验用户权限。首先，基于用户角色和`MetricDefinition`中的`default_roles`以及`is_active`状态，确定该用户有权看到哪些指标（`metric_key`列表）。
 * [ ] **计算:** 遍历这个 `metric_key` 列表，对每一个 key 执行相应的计算逻辑（例如，`period_sales_amount` 就去 `reports` 表里按筛选条件求和），组装成最终的 JSON 返回。

4. **前端仪表盘核心搭建 (第5-7天):**
 * [ ] **(前端)** 创建 `AnalyticsDashboard.vue`、`FilterBar.vue`、`DataCard.vue` 和 `CardGrid.vue`。
 * [ ] 将 `AnalyticsDashboard.vue` 与 `GET /api/analytics/summary` 对接。
 * [ ] 实现筛选器与数据获取的联动。此时，当您更改筛选条件，应该能看到数据卡片上的数字实时变化。

5. **联动趋势图开发 (第8天):**
 * [ ] **(后端)** 开发 `GET /api/analytics/trend` 接口。
 * [ ] **(前端)** 创建 `TrendChartModule.vue`。在 `AnalyticsDashboard.vue` 中管理一个状态 `activeMetricKey`。
 * [ ] **(前端)** 实现点击 `DataCard.vue` 时，更新 `activeMetricKey`，然后 `TrendChartModule.vue` 根据这个新 key 获取数据并重绘图表。

6. **AI 深度洞察集成 (第9-10天):**
 * [ ] **(后端)** 开发 `POST /api/analytics/ai-insight` 接口。
 * [ ] **关键:** 在接口内部根据 `metric_key` 和筛选条件，去数据库**查询原始明细数据**，将其整理成一个干净的 JSON 数组。
 * [ ] 编写两个Prompt模板（个人、团队），将这个 JSON 数组作为上下文喂给 AI。
 * [ ] **(前端)** 在 `DataCard.vue` 上添加 AI 按钮，点击时调用此接口，并用一个 `El-Dialog` 或 `El-Drawer` 来展示 AI 的分析结果。

---

这份详细的蓝图现在已完全根据您的反馈定制。您可以放心地按照这个步骤开始您的重构之旅。如果您在开发过程中遇到任何具体的技术难题，随时可以再来找我。祝您编码愉快！
