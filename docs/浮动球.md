### **结构化技术需求文档（完整版）：可拖拽的全局 AI 问答浮动球**

#### **1. 项目/功能概述 (Overview)**

为现有系统集成一个全局AI浮动球助手。该助手**支持用户在屏幕上拖拽移动**，点击后展开对话弹窗。其核心功能是作为一个“系统向导”，根据预设的系统知识库，指导用户如何查找信息和使用各项功能，而不是直接执行操作。该功能对所有用户可见。

#### **2. 核心功能点 (Core Features)**

* **可拖拽浮动球：** 在系统所有页面展示一个可拖拽的AI浮动球图标。用户长按并移动可改变其位置。
* **单击展开：** 单击浮动球，在其旁边（例如右侧或左侧，取决于球的位置）弹出一个简洁的聊天窗口。
* **交互式弹窗：** 再次单击浮动球或点击窗口外的区域可关闭聊天窗口。
* **引导式对话：** 聊天窗口打开时，AI主动发送欢迎语和推荐问题。
* **智能问答：** 用户输入问题，AI根据后台提供的“系统知识”进行回答。
* **临时性会话：** 聊天记录仅在当前页面会话中保留，刷新网页后清空。
* **后台可配置：** 管理员可在`AdminAI.vue`页面为此智能体配置核心指令。
* **位置记忆：** （可选，但推荐）浮动球的位置在页面刷新后能被记住。

#### **3. 技术规格 (Technical Specifications)**

##### **前端 (Frontend)**

* **页面/组件 (Pages/Components):**
 1. **`AIFloatingBall.vue` (新建):**
 * **核心功能:** 负责渲染浮动球和聊天弹窗，并处理所有交互逻辑。
 * **拖拽实现:** 需要监听鼠标（或触摸屏）的 `mousedown`, `mousemove`, 和 `mouseup` 事件。
 * `onMousedown`: 记录起始位置和时间戳，设置一个“拖拽中”的标志位。
 * `onMousemove`: 如果“拖拽中”标志位为真，则根据鼠标移动的距离实时更新浮动球的 `style`（`left` 和 `top` 属性）。
 * `onMouseup`: 清除“拖拽中”标志位。同时，通过检查 `mousedown` 到 `mouseup` 的时间差和移动距离，判断这是一个“单击”事件还是“拖拽”事件。如果时间短且移动距离小，则触发聊天窗口的展开/收起。
 * **位置状态管理:** 使用 `ref` 来存储浮动球的当前位置 `{ x: Number, y: Number }`。
 * **弹窗定位:** 聊天弹窗的位置需要根据浮动球的当前位置动态计算。例如，如果球在屏幕右半边，弹窗在球的左边弹出；反之亦然。
 * **位置记忆实现 (可选):** 在 `onMouseup` 事件结束拖拽时，将最终的位置坐标 `{x, y}` 保存到浏览器的 `localStorage` 中。在组件 `onMounted` 时，优先从 `localStorage` 读取位置，如果没有则使用默认位置。
 * **UI元素:** 浮动球图标、聊天记录区、输入框、发送按钮、推荐问题按钮。
 2. **`AdminAI.vue` (修改):**
 * 为此智能体增加一个多行文本输入框，用于编辑和保存其“系统提示 (System Prompt)”。

* **用户流程 (User Flow):**
 1. 用户加载页面，看到右下角的AI浮动球。
 2. **（新）拖拽操作：** 用户按住浮动球并拖动到屏幕任意位置。松开后，球停留在新位置。
 3. **（新）单击操作：** 用户快速点击浮动球，聊天弹窗展开。
 4. AI显示欢迎语和推荐问题。
 5. 用户提问，组件将请求发送给后端API。
 6. 组件接收并显示AI的回答。
 7. 用户再次单击浮动球，或点击页面其他地方，聊天弹窗关闭。

* **数据交互 (Data Interaction):**
 * **获取系统知识:** `GET /api/ai/system-knowledge` (无变化)
 * **发起聊天:** `POST /api/ai/chat` (无变化)

##### **后端 (Backend)**

* **API 接口 (API Endpoints):** (与上一版完全相同)
 1. `GET /api/ai/system-knowledge`
 2. `POST /api/ai/chat`
* **数据模型 (Data Models):** (与上一版完全相同)
 * **`AIAgent` 表 (修改):** 增加 `system_prompt` (TEXT) 字段。

#### **4. 技术栈建议 (Tech Stack Suggestion)**

* **前端:**
 * **Vue 3 / Element Plus:** 保持一致。
 * **（推荐库）`@vueuse/core`:** 这是一个非常强大的 Vue 组合式函数库，其中 `useDraggable` 这个函数可以极大地简化拖拽功能的实现。它已经帮你处理好了 `mousedown`, `mousemove` 等所有逻辑。
* **后端:** **Python (Flask / FastAPI)** (无变化)。

#### **5. 开发步骤建议 (Development Steps)**

这是更新后的详细步骤，包含了拖拽功能的实现。

1. **后端准备工作（无变化）:**
 * **1.1 (数据库):** 修改 `AIAgent` 模型，增加 `system_prompt` 字段。
 * **1.2 (创建知识):** 在代码中硬编码一份“系统知识”文档。
 * **1.3 (API实现):** 创建 `GET /api/ai/system-knowledge` 接口。
 * **1.4 (核心聊天API):** 创建 `POST /api/ai/chat` 接口，集成大模型调用。

2. **前端组件开发 (`AIFloatingBall.vue`):**
 * **步骤 2.1 (安装依赖):** （如果决定使用）运行 `npm install @vueuse/core`。
 * **步骤 2.2 (基本UI):** 创建一个 `div` 作为浮动球，使用 `position: fixed` 让它浮动。再创建一个 `div` 作为聊天窗口，默认隐藏 (`v-if` 或 `display: none`)。
 * **步骤 2.3 (实现拖拽):**
 * **使用 `@vueuse/core` (推荐):**
 ```javascript
 import { ref } from 'vue'
 import { useDraggable } from '@vueuse/core'

 // 在 setup 中
 const el = ref(null) // 绑定到浮动球的 div
 const { x, y, isDragging } = useDraggable(el, {
 initialValue: { x: window.innerWidth - 80, y: window.innerHeight - 80 }
 })
 ```
 然后你只需要将 `el` 绑定到你的浮动球 `div`，并使用 `x` 和 `y` 来设置它的样式 `style`。
 * **手动实现 (不推荐，但可以学习):** 在组件中编写 `handleMouseDown`, `handleMouseMove`, `handleMouseUp` 函数来手动控制位置。
 * **步骤 2.4 (区分单击和拖拽):**
 * `useDraggable` 已经提供了一个 `isDragging` 状态。你可以监听它的变化，或者在 `@mouseup` 事件中检查 `isDragging` 的值。如果拖拽结束时 `isDragging` 为 `false`（或者移动距离很小），就判定为单击，执行切换聊天窗口的函数。
 * 更简单的做法是，用一个变量记录 `mousedown` 时的状态，在 `@click` 事件触发时，检查这个变量来判断是否执行弹窗逻辑。
 * **步骤 2.5 (聊天UI):** 实现聊天记录渲染区和输入框。
 * **步骤 2.6 (位置记忆):**
 * 使用 `@vueuse/core` 的 `useStorage` 函数可以轻松实现。
 * 手动实现：在拖拽结束时调用 `localStorage.setItem('ai-ball-position', JSON.stringify({ x: x.value, y: y.value }))`。在 `onMounted` 时 `localStorage.getItem` 来恢复位置。

3. **前后端连接与全局集成（无变化）:**
 * **步骤 3.1 & 3.2:** 实现获取知识和发送消息的逻辑。
 * **步骤 3.3:** 在主布局文件中集成 `<AIFloatingBall />` 组件。

4. **后台配置页面 (`AdminAI.vue`)（无变化）:**
 * **步骤 4.1 & 4.2:** 添加 `textarea` 和保存按钮，实现 `system_prompt` 的更新。

---

现在，我们有了一个包含拖拽功能的完整开发计划。这个方案既满足了你的新需求，又考虑了最佳实践（例如使用 `@vueuse/core` 简化开发）。

你可以从**步骤 2** 开始，专注于前端组件的实现。如果你在任何一步需要代码示例，比如“如何使用 `useDraggable`”，请直接告诉我，我会提供相应的代码片段来帮助你理解。
