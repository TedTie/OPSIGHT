# KillerApp 开发文档（反向） v1.0.0

> 基于当前项目代码反向梳理出的开发参考文档，用于快速了解系统架构、核心模型、接口契约、前端数据流与页面交互，便于后续维护与二次开发。

## 一、概述
- 技术栈：
  - 后端：FastAPI + SQLAlchemy + SQLite
  - 前端：Vue 3 + Pinia + Element Plus + Axios
- 认证方式：服务端 Session（Cookie，`withCredentials: true`）；前端本地 `token`/`user` 主要用于路由守卫与状态恢复。
- 版本：`backend/app/main.py` 中 `version="1.0.0"`
- 代码结构（核心）：
  - 后端：`backend/app/main.py`（绝大多数接口）、`backend/app/api/v1/endpoints/tasks.py`（任务进度/接龙）、`backend/app/models.py`（数据模型）、`backend/app/schemas.py`（Pydantic 模型）、`backend/app/auth.py`（会话认证）
  - 前端：`frontend/src/utils/api.js`（Axios 配置）、`frontend/src/stores/auth.js`（登录态）、`frontend/src/router/*.js`（路由与守卫）、`frontend/src/views/*.vue`（页面）

## 二、架构总览
- 后端
  - 应用入口：`app/main.py`。注册 CORS、Session 中间件；集中定义 `/api/v1` 下的大多数业务接口，并包含 `/analytics/...` 的无前缀别名端点以便前端调用。
  - 会话认证：`auth.py` 与 `main.py` 的 `get_current_user` / `get_current_active_user`。登录写入 `request.session['user_id']`、`username` 与 `user` 对象。
  - 路由：`app.include_router(tasks_v1_router, prefix="/api/v1/tasks")` 挂载 `endpoints/tasks.py` 内任务进度与接龙接口。
  - 数据库：`db.py` 维护 `SessionLocal`；`models.py` 定义实体与枚举；`schemas.py` 定义请求/响应模型。
- 前端
  - Axios：`utils/api.js`，默认 `baseURL: '/api/v1'`，启用 `withCredentials`，统一请求/响应日志与错误提示。
  - 路由：`router/index.js`、`router/simple_routes.js`，登录守卫基于本地 `token` 存在与会话状态；页面组件按需懒加载。
  - 状态：`stores/auth.js` 管理登录、登出、用户信息与角色（`admin`/`super_admin`/`user`）。

## 三、认证与权限
- 登录：`POST /api/v1/auth/login`，成功后后端写入 Session；前端携带 Cookie 访问其他接口。
- 会话状态：`GET /api/v1/auth/me` 获取用户信息；`GET /api/v1/auth/check` 做快速认证检查。
- 登出：`POST /api/v1/auth/logout` 清理会话。
- 权限规则（后端强校验）：
  - 超级管理员：可访问/管理全局与所有组数据。
  - 管理员：仅本组数据；部分管理操作受限。
  - 普通用户：仅访问个人数据。
- 前端拦截：
  - `401` 登录失败（不跳转，仅消息）；会话过期（清本地态并跳转 `/login`）。
  - `403/404/422/500` 提示具体错误信息。

## 四、核心数据模型（节选）
- 用户与组织
  - `User`：`username`、`role`（`user`/`admin`/`super_admin`）、`identity_type`（`CC`/`SS`/`LP`/`SA`）、`organization`、`group_id`、活跃状态；权限辅助方法：`is_super_admin`、`is_admin`、`has_permission`、`can_manage_ai`。
  - `UserGroup`：`name`、`description`、`members`（关系）。
- 任务
  - `Task`：`task_type`（`checkbox`/`normal`/`amount`/`quantity`/`jielong`）、`assignment_type`、`priority`、`status`、`tags`。类型专属字段：
    - 金额型：`target_amount`、`current_amount`、聚合/个人进度派生字段
    - 数量型：`target_quantity`、`current_quantity`
    - 接龙型：`jielong_target_count`、`jielong_config`（`id_enabled`/`remark_enabled`/`intention_enabled`/可自定义字段）
    - 勾选型：`TaskCompletion` 记录完成状态
  - 记录：`TaskRecord`（金额/数量提交）、`TaskCompletion`（勾选完成）、`TaskJielongEntry` 与 `JielongRecord`（接龙参与）
- 日报
  - `DailyReport`：`work_date`、`work_summary/title`、`task_progress`、工作时长、情绪/效率分、销售/业务 KPI（如 `new_sign_amount`、`renewal_amount` 等）、`ai_analysis`（含 `tasks_snapshot`）。
- AI
  - `AIAgent`/`AIFunction`/`AICallLog`/`AISettings`：智能体与功能点配置、调用日志与统计、全局 AI 设置。
- 其他
  - `SystemSettings`（系统设置）、`AdminMetric`（后台指标）、`MonthlyGoal`（按身份与范围的月度目标）。

## 五、主要接口（按域）
- 认证
  - `POST /api/v1/auth/login`
  - `POST /api/v1/auth/logout`
  - `GET /api/v1/auth/me`
  - `GET /api/v1/auth/check`
- 用户与组织
  - 组：`POST/GET/PUT/DELETE /api/v1/groups`，成员管理 `GET/POST/DELETE /api/v1/groups/{group_id}/members`
  - 用户：`GET /api/v1/users`、`GET/PUT/DELETE /api/v1/users/{user_id}`
- 任务
  - CRUD：`POST/GET/PUT/DELETE /api/v1/tasks`、`GET /api/v1/tasks/{task_id}`
  - 进度更新：`PUT /api/v1/tasks/{task_id}/progress`
  - 接龙参与与查询：`POST /api/v1/tasks/{task_id}/jielong`、`GET /api/v1/tasks/{task_id}/jielong`
  - 记录/完成列表：`GET /api/v1/tasks/{task_id}/records`、`GET /api/v1/tasks/{task_id}/completions`
- 日报
  - CRUD：`POST/GET/PUT/DELETE /api/v1/reports`、`GET /api/v1/reports/{report_id}`
  - 快照构建：`POST /api/v1/reports/{report_id}/build-snapshot`
  - AI 分析：`POST /api/v1/reports/{report_id}/ai-analysis`
- 分析与统计
  - 汇总：`GET /api/v1/analytics/summary`
  - 趋势：`GET /api/v1/analytics/trend`
  - 仪表盘：`GET /api/v1/analytics/dashboard`
  - 任务/日报统计：`GET /api/v1/analytics/task-stats`、`GET /api/v1/tasks/weekly-trend`、`GET /api/v1/tasks/reports/stats/summary`
  - 数据集与图表：`GET /api/v1/analytics/data`、`GET /api/v1/analytics/charts`（均有无前缀别名 `/analytics/...`）
  - AI 洞察：`GET /api/v1/analytics/ai-insights`、`POST /api/v1/analytics/ai-insight-summary`
- AI 配置与日志
  - 智能体：`POST/GET/PUT/DELETE /api/v1/ai/agents`
  - 功能点：`POST/GET/PUT /api/v1/ai/functions`
  - 调用与日志：`POST /api/v1/ai/call`、`GET /api/v1/ai/logs`、`GET /api/v1/ai/stats`
- 设置与目标
  - 系统设置：`GET/PUT /api/v1/settings/system`；AI 设置：`GET/PUT /api/v1/settings/ai`
  - 月度目标：`GET/POST /api/v1/goals/monthly`；分析侧读写：`GET/PUT /api/v1/analytics/goals/monthly`

## 六、典型接口契约（示例）
- 更新任务进度（金额/数量型）
  - `PUT /api/v1/tasks/{task_id}/progress`
  - 请求体示例：
    ```json
    {
      "progress_type": "amount",            
      "increment_value": 5000,               
      "notes": "客户A收款，合同X"
    }
    ```
  - 响应：任务对象，含更新后的 `current_amount`/`current_quantity` 及个人/聚合进度派生值。

- 接龙参与（个人）
  - `POST /api/v1/tasks/{task_id}/jielong`
  - 请求体示例（字段受 `jielong_config` 控制）：
    ```json
    {
      "student_id": "S-10086",
      "notes": "到访，意向较强",
      "intention": "strong",
      "custom_field": {
        "name": "渠道",
        "value": "抖音"
      }
    }
    ```
  - 响应：创建的参与记录；进度相关接口/字段在任务详情中展示。

- 分析汇总（含身份/范围）
  - `GET /api/v1/analytics/summary?identity_type=CC&scope=group&group_id=1&year=2025&month=11`
  - 响应示例（节选字段）：
    ```json
    {
      "totalReports": 42,
      "new_sign_amount": 120000,
      "renewal_amount": 30000,
      "call_count": 560,
      "conversion_rate": 0.23,
      "progress": { "upgrade_rate": 0.12 }
    }
    ```

## 七、前端页面与数据流（关键路径）
- 仪表盘 `views/Dashboard.vue`
  - 卡片：待处理/进行中/已完成/本周日报。
  - 数据源：`GET /analytics/charts`（状态饼图），`GET /analytics/stats`（日报数），最近任务 `GET /tasks`，最近日报 `GET /reports`。
  - 操作：进入任务/日报/分析页；点击列表项进入详情。
- 任务页 `views/Tasks.vue`
  - 列表与筛选：类型、优先级、状态、分配范围；管理员/超管可切换用户/组视角。
  - 详情：不同任务类型的进度展示；接龙任务支持"我的/全部"记录切换，快速参与调用 `POST /tasks/{id}/jielong`。
  - 进度：金额/数量型通过 `PUT /tasks/{id}/progress` 更新；勾选型使用 `TaskCompletion` 记录。
- 日报页 `views/Reports.vue`
  - 列表：支持日期范围与组/用户过滤；字段兼容（`work_summary/title → summary`，`task_progress → completed_tasks`）。
  - 详情：展示 `ai_analysis.tasks_snapshot` 的分层任务进度（今日完成/今日到期/进行中/逾期）。
  - 表单：创建/更新，支持生成任务快照与 AI 分析。
- 分析页 `views/AnalyticsDashboard.vue` / `views/Analytics.vue`
  - 汇总卡片、趋势图、排行、AI 洞察弹窗；超管默认视角 `ALL`。
  - 接口：`GET /analytics/summary`、`GET /analytics/trend`、`POST /analytics/ai-insight-summary`。
- 管理页与个人信息
  - `AdminAI.vue`：`CombinedAIConfig.vue` 配置智能体/功能点；日志查看。
  - `AdminUsers.vue`：用户列表与创建编辑；角色/状态筛选。
  - `AdminGroups.vue`：组列表与创建（仅超管）。
  - `Profile.vue`：用户基本信息、角色/身份标签与活跃状态。

## 八、错误处理与日志
- Axios 请求日志：统一输出 `method`、`url`、`fullURL`、`data`。
- 响应错误：
  - `401`：登录失败（不跳转）、会话过期（清态并跳转 `/login`）。
  - `403/404/422/500`：标准化消息提示；500 附带上下文日志。
- 网络错误：区分 `ECONNREFUSED`、超时、CORS/网络异常，给出具体友好提示。

## 九、部署与开发
- 后端（开发）
  - 安装依赖：`pip install -r backend/requirements.txt`
  - 启动服务：`uvicorn app.main:app --reload`（工作目录 `backend/`）
- 前端（开发）
  - 安装依赖：`npm install`（工作目录 `frontend/`）
  - 启动开发：`npm run dev`
  - 接口前缀：`VITE_API_BASE_URL='/api/v1'`；需与后端 CORS 和 Session 配置匹配。

## 十、安全与合规建议
- 会话存储：当前为内存会话（`auth.py` 注释），生产建议使用 Redis 并设置 `SessionMiddleware` 安全属性（`httpsOnly`、`sameSite`）。
- API Key：`AIAgent.api_key` 不应在前端透出；返回时建议脱敏。
- 权限：后端强校验；前端 UI 仅用于引导与提示，不可作为安全边界。

## 十一、已实现与待完善
- 已实现
  - 用户/组管理与权限控制
  - 任务全生命周期与多类型进度、接龙参与与记录
  - 日报 CRUD、任务快照与 AI 分析
  - 分析模块（汇总、趋势、排行、AI 洞察），含无前缀别名接口
  - AI 管理（智能体/功能点）、调用日志与统计
  - 系统与 AI 设置
  - 前端仪表盘、任务、日报、分析、管理与个人页
- 待完善（建议）
  - 将会话后端存储切换为 Redis，补齐安全参数
  - 完善接口契约文档与 Swagger/Redoc，统一分页/过滤
  - 对 `AIAgent.api_key` 返回脱敏；操作日志与审计
  - 增加端到端测试：进度更新、接龙参与、日报快照与 AI 洞察
  - 前端对后端字段的兼容映射策略文档化（如 `work_summary/title`）

## 十二、协作建议
- 契约先行：以 `schemas.py` 为单一事实源，前端严格按响应模型映射；后端新增字段保持向后兼容。
- 视角一致：管理员/超管/用户的数据可见性后端统一过滤（`apply_visibility_filters`）；前端仅做分层展示。
- 路由别名策略：分析模块保留 `/api/v1/...` 与 `/analytics/...` 双路径；前端默认使用短路径，需要与后端保持一致。

---
最后更新：依据当前代码库（`e:\51\AI\KillerApp`）生成。如需补充具体字段说明或更多接口示例，请在 Issue 中标注需求。