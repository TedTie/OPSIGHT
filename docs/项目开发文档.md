## 1. 项目概述

**系统名称：** 智能任务与日报管理系统
**目标：**
构建一套支持组织分级、任务分发、日报记录与 AI 智能分析的企业管理系统。通过AI模块自动完成情感计算与反思总结，用于团队绩效、幸福度与管理决策辅助。

**核心需求点：**
- 多角色登录与组别隔离
- 任务派发与进度追踪
- 日报填写与内容AI分析
- 可配置的指标体系（超级管理员）
- 统一AI调用接口 via **OpenRouter API**
- 模型由超级管理员选择以下三种之一：
 - `google/gemini-2.5-pro`
 - `openai/gpt-5`
 - `deepseek/deepseek-chat-v3.1`

---

## 2. 系统架构概览

**架构模式：** 前后端分离，AI子服务微模块化设计

| 层级 | 技术栈 | 说明 |
|------|---------|------|
| 前端层 | Vue3 + Element Plus + ECharts | 用户界面与可视化 |
| 业务层 | FastAPI + SQLAlchemy | 主 API 服务 |
| AI服务层 | OpenRouter API 调用封装 | AI 模型统一接入层 |
| 数据层 | PostgreSQL + Redis | 主存与缓存系统 |
| 部署层 | Docker Compose + Nginx | 可容器化的部署方案 |

---

## 3. 用户角色与权限体系

| 角色 | 标识 | 范围 | 特权 |
|------|------|------|------|
| 超级管理员 | `super_admin` | 全局 | 用户/组管理、任务派发、自定义指标、AI配置 |
| 管理员 | `cc_admin`, `ss_admin`, `lp_admin` | 各身份/组内 | 派发与审核任务、查看组内日报与AI分析 |
| 普通用户 | `cc`, `ss`, `lp` | 个人 | 接受任务、提交日报、查看AI反馈 |

---

## 4. 核心模块说明

### 4.1 登录与权限系统
- 支持 JWT Token 验证
- 用户表存储加密密码（bcrypt）
- 登录后自动识别角色并跳转对应首页

### 4.2 用户与组别管理
- 超级管理员可创建身份或组
- 管理员只能查看自身组内成员
- 普通用户仅能查看自身信息

### 4.3 任务与执行管理
- 管理员与超管可创建任务
- 可按组别、身份、个人、全体分配
- 任务支持状态流转：`pending → processing → done`

### 4.4 日报子系统
- 普通用户每天提交日报（内容结构如下）
```json
  { "title": "7月20日日报", "content": "...正文...", "progress": "80%" }
  ```
- 后端保存后触发 AI 情感分析
- AI 自动生成 `summary` 和 `reflection`

### 4.5 数据分析与可视化模块
- 使用 ECharts 实现多维度图表
- 可查看：
  - 任务完成率
  - 日报提交率
  - 平均情绪值
  - 异常情绪比例
- 支持按时间、组别筛选  

### 4.6 自定义指标系统（仅超级管理员）
- 超级管理员可在前端可视界面编写公式：
  ```js
  效能指数 = 完成率 * 0.7 + 情绪均值 * 0.3
  ```
- 系统解析并计算生成指标字段

### 4.7 AI 智能分析模块（OpenRouter 专用）
- 所有 AI 分析行为通过统一接口：
  `https://openrouter.ai/api/v1/chat/completions`
- 模型由超级管理员配置
- 支持三种：Gemini 2.5 Pro / GPT5 / DeepSeek v3.1
- 模块组成：
  1. **EmotionAgent**：情感分析  
  2. **ReflectionAgent**：日报摘要与反思生成  
  3. **AnalyticsAgent**：周期总结报告

---

## 5. 用户工作流

### 普通用户工作流

1. 登录 → 系统识别用户身份与分组  
2. 查看任务列表 `/api/tasks?user_id`  
3. 更新任务状态  
4. 填写日报 `/api/reports (POST)`  
5. 后端自动调用 AI 进行情感分析  
6. 页面实时展示：
   - 情绪分（0~1）
   - AI 反思文本
7. 查看“我的分析”页查看曲线趋势

**后台处理链：**
```
用户 → FastAPI → AI Service → OpenRouter → 返回情感得分/反思 → ai_results 表持久化
```

---

## 6. 管理员工作流

1. 登录（系统识别 admin 身份）  
2. 创建任务 `/api/tasks (POST)`  
3. 查看任务执行进度 `/api/tasks?group_id`  
4. 查看组员日报列表 `/api/reports/group`  
   - 可过滤时间/成员
   - 查看AI情感分
5. 打开“分析中心”：
   - 图表展示工作量、幸福感趋势
   - 识别异常个体
6. 生成组别报告 `/api/ai/analytics`
   - 自动输出AI总结段落，例如：
     ```
     SS组本周任务完成率达95%，情感均值0.72，情绪稳定性上升。
     ```

---

## 7. 超级管理员工作流

1. 登录 → 跳转“系统配置后台”  
2. 管理用户/组别
   - 创建身份/组
   - 重置密码
   - 删除成员  
3. 管理任务模板  
4. 管理自定义指标（保存到 `custom_metrics`）
5. 进入「AI配置」：
   - 从下拉框选择模型：
     - google/gemini-2.5-pro  
     - openai/gpt-5  
     - deepseek/deepseek-chat-v3.1  
   - 输入 OpenRouter API Key  
   - 点击“保存” → `/api/ai/config (PUT)`
6. 查看 AI 调用日志与费用统计表  

---

## 8. 数据库设计

### users
| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| username | varchar | 用户名 |
| password_hash | varchar | 密码哈希 |
| role | varchar | cc/ss/lp/管理员/超管 |
| group_id | bigint | 所属组别 |
| created_at | timestamp | 创建时间 |

### user_groups
| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| name | varchar | 组别名 |
| identity | varchar | 所属身份 |
| created_at | timestamp | 创建时间 |

### tasks
| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| title | varchar | 任务标题 |
| description | text | 描述 |
| assigned_to | bigint | 接收用户id或标识“ALL_xx” |
| status | varchar | pending/processing/done |
| start_time | timestamp | 开始时间 |
| end_time | timestamp | 结束时间 |

### reports
| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| user_id | bigint | 提交人 |
| group_id | bigint | 所属组 |
| content | text | 日报内容 |
| progress | varchar | 任务进度说明 |
| created_at | timestamp | 提交时间 |

### ai_results
| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| report_id | bigint | 外键日报id |
| emotion_score | float | 情感分 |
| emotion_category | varchar | positive/neutral/negative |
| summary | text | AI生成摘要 |
| reflection | text | AI反思内容 |
| model_used | varchar | openai/gpt-5等 |
| created_at | timestamp | 时间戳 |

### ai_config
| 字段 | 类型 | 描述 |
|------|------|------|
| id | bigint | 主键 |
| model_selected | varchar | 当前选择模型 |
| api_key | varchar | OpenRouter API Key (加密) |
| updated_by | varchar | 更新人 |
| updated_at | timestamp | 更新时间 |

### custom_metrics
| 字段 | 类型 | 描述 |
|------|------|------|
| id | bigint | 主键 |
| name | varchar | 指标名 |
| formula | text | JS公式 |
| created_by | varchar | 超管名 |
| created_at | timestamp | 时间戳 |

---

## 9. RESTful API 设计

### 用户登录与信息
| 方法 | 路径 | 描述 |
|------|------|------|
| POST | `/api/login` | 登录获取JWT |
| GET | `/api/users/me` | 当前用户信息 |

### 任务与日报
| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/tasks` | 获取任务列表 |
| POST | `/api/tasks` | 创建任务（管理员以上） |
| PUT | `/api/tasks/{id}` | 更新任务状态 |
| POST | `/api/reports` | 提交日报 |

### 数据分析
| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/analytics/summary` | 汇总统计 |
| GET | `/api/analytics/trends` | 趋势分析 |

### AI模块
| 方法 | 路径 | 描述 |
|------|------|------|
| POST | `/api/ai/emotion` | 情感分析 |
| POST | `/api/ai/reflection` | 日报反思生成 |
| POST | `/api/ai/analytics` | 聚合总结 |
| GET | `/api/ai/models` | 支持模型列表 |
| GET | `/api/ai/config` | 当前AI配置 |
| PUT | `/api/ai/config` | 更新AI配置（超管） |

---

## 10. AI 模块（OpenRouter）

### 通用调用结构

**Endpoint**  
`POST https://openrouter.ai/api/v1/chat/completions`

**Headers**
```http
Authorization: Bearer {API_KEY}
HTTP-Referer: https://yourapp.com
X-Title: Intelligent Task System
Content-Type: application/json
```

**Body**
```json
{
"model": "openai/gpt-5",
"messages": [
 {"role": "system", "content": "你是任务系统分析助手。"},
 {"role": "user", "content": "分析以下日报并输出情感分与摘要：今天任务延迟但已解决。"}
]
}
```

**标准响应格式**
```json
{
"id": "resp_123",
"model": "openai/gpt-5",
"choices": [{
 "message": {"content": "情绪：中性略偏积极，情感分0.68。摘要：任务虽延迟但压力释放。"}
}]
}
```

---

## 11. 环境变量配置

```bash
DATABASE_URL=postgresql://user:password@localhost:5432/taskdb
REDIS_URL=redis://localhost:6379/0

SECRET_KEY=your_secret
JWT_EXPIRE_SECONDS=3600

AI_PROVIDER=openrouter
AI_API_BASE=https://openrouter.ai/api/v1/chat/completions
DEFAULT_AI_MODEL=openai/gpt-5
OPENROUTER_API_KEY=sk-xxxxx
```

---

## 12. 前端页面结构

| 页面 | 说明 |
|------|------|
| /login | 用户登录 |
| /dashboard | 任务与日报概览 |
| /tasks | 我的任务 |
| /report | 日报填写页（支持AI反馈展示） |
| /analysis | 可视化分析页面 |
| /admin | 管理员任务与日报汇总页 |
| /super/config | 超管配置页（模型选择、API Key、公式定义） |

---

## 13. 安全与合规设计

- 所有API需携带JWT  
- 密码加密存储(bcrypt)
- AI Key 加密存放数据库  
- 使用 HTTPS 通信  
- AI 调用速率控制 (10次/分钟/用户)
- 记录AI调用日志至 `ai_call_log`
  - user_id  
  - model_used  
  - result_status  
  - duration_ms  

---

## 14. 日志与监控

系统输出统一日志格式：
```
[2024-07-20 10:12:34] INFO user=tom action=report_submit ai_model=openai/gpt-5 latency=1300ms status=success
```

监控维度：
- 任务处理时间
- AI调用成功率
- 每用户调用频率

---

## 15. 开发阶段与任务拆解

| 阶段 | 模块 | 主要任务 |
|------|------|-----------|
| 阶段1 | 登录与权限系统 | 完成JWT验证、角色识别 |
| 阶段2 | 用户与组管理 | 用户CRUD、分组架构 |
| 阶段3 | 任务与日报模块 | 任务创建、日报提交流程 |
| 阶段4 | 数据分析中心 | 图表与接口关联 |
| 阶段5 | 自定义指标系统 | 公式编辑器、后端解析器 |
| 阶段6 | AI模块 via OpenRouter | Emotion / Reflection / Analytics Agent |
| 阶段7 | 日志、安全、部署 | 加密、速率限制、Docker部署 |

---

## 16. 部署说明

**Docker Compose 样例：**

```yaml
version: '3.9'
services:
backend:
 build: ./backend
 env_file:
 - .env
 ports:
 - "8000:8000"
 depends_on:
 - postgres
 - redis
frontend:
 build: ./frontend
 ports:
 - "8080:80"
postgres:
 image: postgres:15
 environment:
 POSTGRES_USER: user
 POSTGRES_PASSWORD: pass
 POSTGRES_DB: taskdb
redis:
 image: redis:7
 ports:
 - "6379:6379"
```

---

## 17. 性能优化与扩展建议

- 后期可使用消息队列 Celery 来异步执行 AI 分析。
- AI结果缓存至 Redis，减少频繁调用。
- 可扩展身份层级（部门/事业部）。
- 计划添加 Webhook 接口与企业IM集成（如 Slack、企业微信）。

---

## ✅ 18. 总结

该文档为项目完整开发参考规范，包含：

- 系统架构、数据库设计、API说明
- 三类角色工作流（用户/管理员/超管）
- OpenRouter AI 模型集成与配置机制
- 环境变量、部署、日志与安全机制
- 开发阶段计划与后续扩展方向
