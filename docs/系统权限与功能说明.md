# OpSight 系统权限与功能说明

## 📋 目录
- [系统概述](#系统概述)
- [权限体系](#权限体系)
- [功能模块](#功能模块)
- [权限控制机制](#权限控制机制)
- [API权限保护](#api权限保护)
- [前端权限控制](#前端权限控制)
- [使用指南](#使用指南)

---

## 🎯 系统概述

OpSight 是一个基于 Vue 3 + FastAPI 的现代化任务管理和数据分析平台，采用三级权限架构，支持多组织、多身份的精细化权限控制。

### 技术架构
- **前端**: Vue 3 + Element Plus + Pinia
- **后端**: FastAPI + SQLAlchemy + SQLite
- **认证**: Cookie-based 身份验证
- **权限**: 基于角色的访问控制 (RBAC)

---

## 🔐 权限体系

### 用户角色层级

#### 1. 普通用户 (User)
- **权限范围**: 个人数据访问
- **功能权限**:
  - ✅ 查看和管理个人任务
  - ✅ 提交个人日报
  - ✅ 查看个人分析数据
  - ✅ 参与分配给自己的任务
  - ✅ 访问知识库
  - ❌ 无管理权限

#### 2. 组管理员 (Admin)
- **权限范围**: 组内数据管理
- **功能权限**:
  - ✅ 普通用户的所有权限
  - ✅ 管理组内任务
  - ✅ 查看组内用户数据
  - ✅ 创建和分配任务给组内成员
  - ✅ 查看组织分析数据
  - ✅ 管理组内成员信息
  - ❌ 无法管理其他组织
  - ❌ 无法访问系统级设置

#### 3. 超级管理员 (Super Admin)
- **权限范围**: 全系统管理
- **功能权限**:
  - ✅ 所有用户和管理员权限
  - ✅ 管理所有用户和组织
  - ✅ 系统配置和设置
  - ✅ AI配置管理
  - ✅ 自定义指标配置
  - ✅ 查看全系统数据
  - ✅ 用户权限分配

### 权限继承机制
```
超级管理员 ⊃ 组管理员 ⊃ 普通用户
```
- 上级权限自动包含下级权限
- 权限检查采用"最高权限优先"原则

---

## 🏗️ 功能模块

### 1. 仪表板 (Dashboard)
**访问权限**: 所有用户
- 📊 任务统计概览
- 📈 个人/组织绩效数据
- 🔔 重要通知和提醒
- 📅 近期任务和截止日期

### 2. 任务管理 (Tasks)
**访问权限**: 所有用户

#### 任务类型支持
- **复选框任务**: 简单的完成/未完成状态
- **数量任务**: 需要达到特定数量目标
- **金额任务**: 需要达到特定金额目标
- **接龙任务**: 多人参与的接龙活动

#### 任务分配方式
- **指定用户**: 分配给特定用户
- **指定组**: 分配给整个组织
- **指定身份**: 分配给特定身份类型的用户
- **所有人**: 全员任务

#### 权限控制
- **创建权限**: 管理员及以上
- **编辑权限**: 任务创建者或管理员
- **删除权限**: 任务创建者或管理员
- **完成权限**: 任务分配对象

### 3. 报告管理 (Reports)
**访问权限**: 所有用户
- 📝 个人日报提交
- 📋 日报历史查看
- 📊 报告统计分析
- 🔍 报告搜索和筛选

### 4. 数据分析 (Analytics)
**访问权限**: 管理员及以上
- 📈 任务完成趋势
- 👥 用户绩效排行
- 📊 组织效率分析
- 🎯 目标达成情况

### 5. 用户管理 (Admin Users)
**访问权限**: 管理员及以上

#### 超级管理员功能
- ✅ 查看所有用户
- ✅ 创建/编辑/删除用户
- ✅ 分配用户权限
- ✅ 管理用户组织归属

#### 组管理员功能
- ✅ 查看组内用户
- ❌ 无法编辑用户权限
- ❌ 无法跨组管理

### 6. 组织管理 (Admin Groups)
**访问权限**: 管理员及以上

#### 超级管理员功能
- ✅ 创建/编辑/删除组织
- ✅ 管理组织成员
- ✅ 设置组织属性

#### 组管理员功能
- ✅ 查看组织信息
- ✅ 查看组织成员
- ❌ 无法编辑组织
- ❌ 无法管理成员

### 7. AI配置 (Admin AI)
**访问权限**: 仅超级管理员
- 🤖 AI模型配置
- 📊 AI使用统计
- ⚙️ AI参数调优
- 📝 AI日志查看

### 8. 系统指标 (Admin Metrics)
**访问权限**: 仅超级管理员
- 📊 系统性能监控
- 📈 用户活跃度统计
- 💾 数据库状态
- 🔧 自定义指标配置

### 9. 系统设置 (Settings)
**访问权限**: 仅超级管理员
- ⚙️ 系统参数配置
- 🔐 安全设置
- 📧 通知配置
- 🎨 界面定制

### 10. 个人资料 (Profile)
**访问权限**: 所有用户
- 👤 个人信息管理
- 🔑 密码修改
- 🎨 个人偏好设置
- 📊 个人统计数据

### 11. 知识库 (Knowledge Base)
**访问权限**: 所有用户
- 📚 文档浏览
- 🔍 知识搜索
- 📖 使用指南
- ❓ 常见问题

---

## 🛡️ 权限控制机制

### 后端权限装饰器

#### `@require_admin`
```python
# 要求管理员或超级管理员权限
@require_admin
def admin_only_endpoint():
    pass
```

#### `@require_super_admin`
```python
# 要求超级管理员权限
@require_super_admin
def super_admin_only_endpoint():
    pass
```

#### `get_current_active_user`
```python
# 获取当前认证用户
def protected_endpoint(current_user: User = Depends(get_current_active_user)):
    pass
```

### 前端权限控制

#### 路由级权限
```javascript
{
  path: 'admin/ai',
  component: AdminAI,
  meta: { requiresSuperAdmin: true }
}
```

#### 组件级权限
```vue
<!-- 管理员及以上可见 -->
<div v-if="authStore.isAdmin || authStore.isSuperAdmin">
  <!-- 管理功能 -->
</div>

<!-- 仅超级管理员可见 -->
<div v-if="authStore.isSuperAdmin">
  <!-- 超级管理员功能 -->
</div>
```

#### 权限工具函数
```javascript
// 检查用户权限
hasPermission(user, permission)

// 检查用户访问权限
canAccessUser(currentUser, targetUser)

// 检查组管理权限
canManageGroup(currentUser, groupId)
```

---

## 🔒 API权限保护

### 认证端点
- `POST /api/v1/auth/login` - 用户登录
- `GET /api/v1/auth/me` - 获取当前用户信息
- `POST /api/v1/auth/logout` - 用户登出

### 用户管理端点
- `GET /api/v1/users` - 获取用户列表 (需要管理员权限)
- `POST /api/v1/users` - 创建用户 (需要超级管理员权限)
- `PUT /api/v1/users/{id}` - 更新用户 (需要管理员权限)
- `DELETE /api/v1/users/{id}` - 删除用户 (需要超级管理员权限)

### 任务管理端点
- `GET /api/v1/tasks` - 获取任务列表 (根据权限过滤)
- `POST /api/v1/tasks` - 创建任务 (需要管理员权限)
- `PUT /api/v1/tasks/{id}` - 更新任务 (创建者或管理员)
- `DELETE /api/v1/tasks/{id}` - 删除任务 (创建者或管理员)

### 组织管理端点
- `GET /api/v1/groups` - 获取组织列表 (根据权限过滤)
- `POST /api/v1/groups` - 创建组织 (需要超级管理员权限)
- `PUT /api/v1/groups/{id}` - 更新组织 (需要超级管理员权限)
- `DELETE /api/v1/groups/{id}` - 删除组织 (需要超级管理员权限)

---

## 🎮 前端权限控制

### 菜单权限控制

#### 主导航菜单
```vue
<!-- 所有用户可见 -->
<el-menu-item index="/dashboard">仪表板</el-menu-item>
<el-menu-item index="/tasks">任务管理</el-menu-item>
<el-menu-item index="/reports">报告管理</el-menu-item>

<!-- 管理员及以上可见 -->
<el-sub-menu v-if="authStore.isAdmin || authStore.isSuperAdmin" index="admin">
  <template #title>管理功能</template>
  <el-menu-item index="/admin/users">用户管理</el-menu-item>
  <el-menu-item index="/admin/groups">组织管理</el-menu-item>
</el-sub-menu>

<!-- 仅超级管理员可见 -->
<el-menu-item v-if="authStore.isSuperAdmin" index="/admin/ai">AI配置</el-menu-item>
<el-menu-item v-if="authStore.isSuperAdmin" index="/settings">系统设置</el-menu-item>
```

### 按钮权限控制

#### 任务管理页面
```vue
<!-- 创建任务按钮 - 管理员及以上 -->
<el-button 
  v-if="authStore.isAdmin || authStore.isSuperAdmin"
  type="primary" 
  @click="openCreateDialog">
  创建任务
</el-button>

<!-- 编辑按钮 - 任务创建者或管理员 -->
<el-button 
  v-if="canEditTask(task)"
  type="primary" 
  size="small"
  @click="editTask(task)">
  编辑
</el-button>

<!-- 删除按钮 - 任务创建者或管理员 -->
<el-button 
  v-if="canDeleteTask(task)"
  type="danger" 
  size="small"
  @click="deleteTask(task)">
  删除
</el-button>
```

### 数据权限过滤

#### 用户数据访问
```javascript
// 超级管理员：查看所有用户
// 组管理员：查看组内用户
// 普通用户：查看自己
const getVisibleUsers = () => {
  if (authStore.isSuperAdmin) {
    return allUsers
  } else if (authStore.isAdmin) {
    return allUsers.filter(user => user.group_id === authStore.user.group_id)
  } else {
    return [authStore.user]
  }
}
```

#### 任务数据访问
```javascript
// 根据任务分配类型和用户权限过滤可见任务
const getVisibleTasks = () => {
  return tasks.filter(task => {
    // 管理员可以看到所有任务
    if (authStore.isAdmin || authStore.isSuperAdmin) {
      return true
    }
    
    // 普通用户只能看到分配给自己的任务
    return isTaskAssignedToUser(task, authStore.user)
  })
}
```

---

## 📖 使用指南

### 管理员操作指南

#### 1. 创建任务
1. 进入"任务管理"页面
2. 点击"创建任务"按钮
3. 填写任务信息：
   - 任务标题和描述
   - 选择任务类型
   - 设置分配方式
   - 设置截止时间和优先级
4. 点击"确定"创建任务

#### 2. 管理用户
1. 进入"管理功能" → "用户管理"
2. 查看用户列表
3. 可以编辑用户信息（超级管理员）
4. 可以分配用户权限（超级管理员）

#### 3. 管理组织
1. 进入"管理功能" → "组织管理"
2. 查看组织列表
3. 管理组织成员
4. 创建/编辑组织（超级管理员）

### 普通用户操作指南

#### 1. 查看和完成任务
1. 进入"任务管理"页面
2. 查看分配给自己的任务
3. 点击任务查看详情
4. 根据任务类型完成任务：
   - 复选框任务：点击"完成"
   - 数量任务：输入完成数量
   - 金额任务：输入完成金额
   - 接龙任务：参与接龙

#### 2. 提交日报
1. 进入"报告管理"页面
2. 点击"新建日报"
3. 填写日报内容
4. 提交日报

#### 3. 查看个人数据
1. 进入"仪表板"查看概览
2. 进入"数据分析"查看详细分析
3. 进入"个人资料"管理个人信息

### 权限问题排查

#### 常见问题
1. **无法访问某个页面**
   - 检查用户权限级别
   - 确认路由权限配置
   - 查看浏览器控制台错误

2. **按钮不显示**
   - 检查权限控制条件
   - 确认用户角色信息
   - 验证权限判断逻辑

3. **API请求被拒绝**
   - 检查后端权限装饰器
   - 确认用户认证状态
   - 查看API响应错误信息

#### 调试工具
- 浏览器开发者工具
- 权限测试页面 (`/permission-test`)
- 按钮测试页面 (`/test-buttons`)

---

## 🔧 技术实现细节

### 认证流程
1. 用户输入用户名登录
2. 后端验证用户信息
3. 生成JWT token并设置Cookie
4. 前端存储用户信息到Pinia store
5. 后续请求携带token进行权限验证

### 权限检查流程
1. 路由守卫检查页面访问权限
2. 组件渲染时检查元素显示权限
3. API请求时后端验证操作权限
4. 数据返回时根据权限过滤内容

### 安全措施
- 所有敏感API都有权限验证
- 前端权限控制防止UI误操作
- 后端权限验证防止恶意请求
- Cookie安全配置防止XSS攻击

---

## 📊 权限矩阵

| 功能模块 | 普通用户 | 组管理员 | 超级管理员 |
|---------|---------|---------|-----------|
| 仪表板 | ✅ | ✅ | ✅ |
| 任务管理 | ✅ 查看分配给自己的 | ✅ 管理组内任务 | ✅ 管理所有任务 |
| 报告管理 | ✅ 个人日报 | ✅ 组内报告 | ✅ 所有报告 |
| 数据分析 | ❌ | ✅ 组内数据 | ✅ 全部数据 |
| 用户管理 | ❌ | ✅ 查看组内用户 | ✅ 管理所有用户 |
| 组织管理 | ❌ | ✅ 查看组织信息 | ✅ 管理所有组织 |
| AI配置 | ❌ | ❌ | ✅ |
| 系统指标 | ❌ | ❌ | ✅ |
| 系统设置 | ❌ | ❌ | ✅ |
| 个人资料 | ✅ | ✅ | ✅ |
| 知识库 | ✅ | ✅ | ✅ |

---

## 📝 更新日志

### v1.0.0 (当前版本)
- ✅ 完整的三级权限体系
- ✅ 基于角色的访问控制
- ✅ 前后端权限一致性验证
- ✅ 细粒度的功能权限控制
- ✅ 安全的API权限保护

### 计划功能
- 🔄 动态权限配置
- 🔄 权限审计日志
- 🔄 更细粒度的数据权限
- 🔄 权限模板和继承

---

**文档版本**: v1.0.0  
**最后更新**: 2024年12月  
**维护者**: OpSight 开发团队