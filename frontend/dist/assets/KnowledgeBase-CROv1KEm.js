import{a as Ke,c as T,E as p,u as He,r as c,K as Pe,s as Ne,ad as je,D as Ye,L as ne,P as y,A as qe,o as Oe,l as w,f as s,g as a,d as b,m as k,w as o,b as d,Q as Qe,e as u,F as K,n as H,p as Ge,ae as Xe,t as i,U as Je,h as x,X as We,V as Ze,k as r,Y as et,af as tt,ag as lt,ac as at,ah as ot,ai as st,y as ue}from"./index-g0Sg6k74.js";import{_ as nt}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ut={class:"knowledge-base-container"},it={class:"module-content"},dt={class:"module-stats"},rt={class:"toolbar"},ct={class:"toolbar-left"},pt={class:"toolbar-right"},ft={class:"knowledge-title"},mt={class:"pagination-container"},_t={key:0,class:"uploaded-files"},vt={class:"dialog-footer"},gt={key:0,class:"knowledge-detail"},yt={class:"knowledge-meta"},wt={class:"meta-info"},bt={class:"meta-info"},ht={key:0,class:"knowledge-description"},kt={class:"knowledge-content"},Vt={class:"content-text"},Ct={key:1,class:"knowledge-files"},xt={class:"file-list"},zt={class:"file-size"},Ut={__name:"KnowledgeBase",setup(Dt){const ie=Ke(),de=He(),m=T(()=>ie.user),Q=T(()=>{var l,e;return((l=m.value)==null?void 0:l.is_admin)||((e=m.value)==null?void 0:e.is_super_admin)});Q.value||(p.error("您没有访问知识库的权限"),de.push("/"));const G=c([{type:"SUMMARY",name:"汇总模块",description:"数据汇总和分析相关知识",icon:Pe,count:0},{type:"CC",name:"CC模块",description:"顾问相关知识和经验",icon:Ne,count:0},{type:"SS",name:"SS模块",description:"班主任相关知识和经验",icon:je,count:0},{type:"LP",name:"LP模块",description:"英文辅导相关知识",icon:Ye,count:0}]),z=c("SUMMARY"),P=c(""),N=c(""),j=c(""),I=c(!1),Y=c(!1),X=c([]),J=c([]),_=ne({page:1,size:20,total:0}),B=c(!1),q=c(!1),F=c(!1),f=c(null),W=c(),n=ne({title:"",description:"",content:"",module_type:"SUMMARY",category:"",status:"DRAFT",is_public:!1,tags:[]}),R=c(""),U=c([]),re={title:[{required:!0,message:"请输入标题",trigger:"blur"}],content:[{required:!0,message:"请输入内容",trigger:"blur"}]},ce=T(()=>`${y.defaults.baseURL}/knowledge-base/upload`),pe=T(()=>({Authorization:`Bearer ${store.state.auth.token}`})),fe=T(()=>({knowledge_id:n.id||null})),me=l=>{z.value=l,n.module_type=l,v()},_e=()=>{_.page=1,v()},ve=({prop:l,order:e})=>{v()},ge=l=>{_.size=l,_.page=1,v()},ye=l=>{_.page=l,v()},we=()=>{v()},be=()=>{F.value=!1,Ce(),B.value=!0},he=l=>{F.value=!0,Object.assign(n,l),R.value=l.tags?l.tags.join(", "):"",U.value=l.files||[],B.value=!0},Z=async l=>{try{const e=await y.get(`/knowledge-base/${l.id}`);f.value=e.data,q.value=!0}catch{p.error("获取知识详情失败")}},ke=async l=>{try{await ue.confirm(`确定要删除知识"${l.title}"吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await y.delete(`/knowledge-base/${l.id}`),p.success("删除成功"),v()}catch(e){e!=="cancel"&&p.error("删除失败")}},Ve=async()=>{try{await W.value.validate(),Y.value=!0,n.tags=R.value?R.value.split(",").map(l=>l.trim()).filter(l=>l):[],F.value?(await y.put(`/knowledge-base/${n.id}`,n),p.success("更新成功")):(await y.post("/knowledge-base/",n),p.success("创建成功")),B.value=!1,v()}catch{p.error(F.value?"更新失败":"创建失败")}finally{Y.value=!1}},Ce=()=>{Object.assign(n,{title:"",description:"",content:"",module_type:z.value,category:"",status:"DRAFT",is_public:!1,tags:[]}),R.value="",U.value=[]},xe=l=>{ue.confirm("确定要关闭吗？未保存的更改将丢失。").then(()=>{l()}).catch(()=>{})},ze=l=>{const h=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","text/plain"].includes(l.type),g=l.size/1024/1024<10;return h?g?!0:(p.error("文件大小不能超过 10MB!"),!1):(p.error("只支持 doc/docx/pdf/txt/xlsx/pptx 格式的文件!"),!1)},Ue=(l,e)=>{l.success&&l.file_info?(U.value.push(l.file_info),p.success("文件上传成功")):p.error(l.message||"文件上传失败")},De=(l,e)=>{p.error("文件上传失败")},Se=async l=>{try{await y.delete(`/knowledge-base/files/${l.id}`),U.value=U.value.filter(e=>e.id!==l.id),p.success("文件删除成功")}catch{p.error("文件删除失败")}},Be=l=>{window.open(`${y.defaults.baseURL}/knowledge-base/files/${l.id}/download`)},v=async()=>{try{I.value=!0;const l={module_type:z.value,page:_.page,size:_.size,search:P.value,category:N.value,status:j.value},e=await y.get("/knowledge-base/search",{params:l});X.value=e.data.items,_.total=e.data.total;const h=await y.get("/knowledge-base/stats");G.value.forEach(g=>{const V=h.data.find(L=>L.module_type===g.type);g.count=V?V.count:0})}catch{p.error("获取知识列表失败")}finally{I.value=!1}},ee=async()=>{try{const l=await y.get("/knowledge-base/categories",{params:{module_type:z.value}});J.value=l.data}catch(l){console.error("获取分类失败:",l)}},te=l=>({DRAFT:"info",PUBLISHED:"success",ARCHIVED:"warning"})[l]||"info",le=l=>({DRAFT:"草稿",PUBLISHED:"已发布",ARCHIVED:"已归档"})[l]||"未知",ae=l=>l?new Date(l).toLocaleString("zh-CN"):"",Fe=l=>{if(!l)return"0 B";const e=1024,h=["B","KB","MB","GB"],g=Math.floor(Math.log(l)/Math.log(e));return parseFloat((l/Math.pow(e,g)).toFixed(2))+" "+h[g]},Re=l=>m.value?!!(m.value.is_super_admin||l.created_by===m.value.id||m.value.is_admin&&l.module_type===m.value.identity_type):!1,Me=l=>m.value?!!(m.value.is_super_admin||l.created_by===m.value.id||m.value.is_admin&&l.module_type===m.value.identity_type):!1;return qe(z,()=>{ee(),v()}),Oe(()=>{ee(),v()}),(l,e)=>{const h=d("el-icon"),g=d("el-card"),V=d("el-col"),L=d("el-row"),M=d("el-input"),D=d("el-option"),O=d("el-select"),S=d("el-button"),oe=d("el-link"),A=d("el-tag"),$=d("el-table-column"),Ae=d("el-table"),$e=d("el-pagination"),C=d("el-form-item"),Ee=d("el-switch"),Le=d("el-upload"),Te=d("el-form"),se=d("el-dialog"),Ie=Qe("loading");return u(),w("div",ut,[e[27]||(e[27]=s("div",{class:"page-header"},[s("h1",null,"知识库管理"),s("p",null,"管理和组织团队知识资源")],-1)),a(L,{gutter:20,class:"module-cards"},{default:o(()=>[(u(!0),w(K,null,H(G.value,t=>(u(),b(V,{span:6,key:t.type},{default:o(()=>[a(g,{class:Ge(["module-card",{active:z.value===t.type}]),onClick:E=>me(t.type),shadow:"hover"},{default:o(()=>[s("div",it,[a(h,{size:32,class:"module-icon"},{default:o(()=>[(u(),b(Xe(t.icon)))]),_:2},1024),s("h3",null,i(t.name),1),s("p",null,i(t.description),1),s("div",dt,[s("span",null,i(t.count||0)+" 条知识",1)])])]),_:2},1032,["class","onClick"])]),_:2},1024))),128))]),_:1}),z.value?(u(),b(g,{key:0,class:"content-card"},{default:o(()=>[s("div",rt,[s("div",ct,[a(M,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=t=>P.value=t),placeholder:"搜索知识...",style:{width:"300px"},clearable:"",onInput:_e},{prefix:o(()=>[a(h,null,{default:o(()=>[a(x(We))]),_:1})]),_:1},8,["modelValue"]),a(O,{modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=t=>N.value=t),placeholder:"选择分类",clearable:"",style:{width:"150px","margin-left":"10px"}},{default:o(()=>[(u(!0),w(K,null,H(J.value,t=>(u(),b(D,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(O,{modelValue:j.value,"onUpdate:modelValue":e[2]||(e[2]=t=>j.value=t),placeholder:"状态",clearable:"",style:{width:"120px","margin-left":"10px"}},{default:o(()=>[a(D,{label:"草稿",value:"DRAFT"}),a(D,{label:"已发布",value:"PUBLISHED"}),a(D,{label:"已归档",value:"ARCHIVED"})]),_:1},8,["modelValue"])]),s("div",pt,[Q.value?(u(),b(S,{key:0,type:"primary",onClick:be,icon:x(Ze)},{default:o(()=>[...e[15]||(e[15]=[r(" 新建知识 ",-1)])]),_:1},8,["icon"])):k("",!0),a(S,{onClick:we,icon:x(et),loading:I.value},{default:o(()=>[...e[16]||(e[16]=[r(" 刷新 ",-1)])]),_:1},8,["icon","loading"])])]),Je((u(),b(Ae,{data:X.value,style:{width:"100%"},onSortChange:ve},{default:o(()=>[a($,{prop:"title",label:"标题","min-width":"200",sortable:"custom"},{default:o(({row:t})=>[s("div",ft,[a(oe,{onClick:E=>Z(t),type:"primary"},{default:o(()=>[r(i(t.title),1)]),_:2},1032,["onClick"]),t.tags&&t.tags.length>0?(u(),b(A,{key:0,size:"small",style:{"margin-left":"8px"}},{default:o(()=>[r(i(t.tags[0]),1)]),_:2},1024)):k("",!0)])]),_:1}),a($,{prop:"category",label:"分类",width:"120"},{default:o(({row:t})=>[a(A,{size:"small",type:"info"},{default:o(()=>[r(i(t.category||"未分类"),1)]),_:2},1024)]),_:1}),a($,{prop:"status",label:"状态",width:"100"},{default:o(({row:t})=>[a(A,{type:te(t.status),size:"small"},{default:o(()=>[r(i(le(t.status)),1)]),_:2},1032,["type"])]),_:1}),a($,{prop:"view_count",label:"查看次数",width:"100",sortable:"custom"}),a($,{prop:"created_at",label:"创建时间",width:"180",sortable:"custom"},{default:o(({row:t})=>[r(i(ae(t.created_at)),1)]),_:1}),a($,{label:"操作",width:"200",fixed:"right"},{default:o(({row:t})=>[a(S,{size:"small",onClick:E=>Z(t),icon:x(tt)},{default:o(()=>[...e[17]||(e[17]=[r(" 查看 ",-1)])]),_:1},8,["onClick","icon"]),Re(t)?(u(),b(S,{key:0,size:"small",onClick:E=>he(t),icon:x(lt)},{default:o(()=>[...e[18]||(e[18]=[r(" 编辑 ",-1)])]),_:1},8,["onClick","icon"])):k("",!0),Me(t)?(u(),b(S,{key:1,size:"small",type:"danger",onClick:E=>ke(t),icon:x(at)},{default:o(()=>[...e[19]||(e[19]=[r(" 删除 ",-1)])]),_:1},8,["onClick","icon"])):k("",!0)]),_:1})]),_:1},8,["data"])),[[Ie,I.value]]),s("div",mt,[a($e,{"current-page":_.page,"onUpdate:currentPage":e[3]||(e[3]=t=>_.page=t),"page-size":_.size,"onUpdate:pageSize":e[4]||(e[4]=t=>_.size=t),"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ge,onCurrentChange:ye},null,8,["current-page","page-size","total"])])]),_:1})):k("",!0),a(se,{modelValue:B.value,"onUpdate:modelValue":e[13]||(e[13]=t=>B.value=t),title:F.value?"编辑知识":"新建知识",width:"80%","before-close":xe},{footer:o(()=>[s("span",vt,[a(S,{onClick:e[12]||(e[12]=t=>B.value=!1)},{default:o(()=>[...e[23]||(e[23]=[r("取消",-1)])]),_:1}),a(S,{type:"primary",onClick:Ve,loading:Y.value},{default:o(()=>[r(i(F.value?"更新":"创建"),1)]),_:1},8,["loading"])])]),default:o(()=>[a(Te,{ref_key:"knowledgeFormRef",ref:W,model:n,rules:re,"label-width":"100px"},{default:o(()=>[a(L,{gutter:20},{default:o(()=>[a(V,{span:12},{default:o(()=>[a(C,{label:"标题",prop:"title"},{default:o(()=>[a(M,{modelValue:n.title,"onUpdate:modelValue":e[5]||(e[5]=t=>n.title=t),placeholder:"请输入知识标题"},null,8,["modelValue"])]),_:1})]),_:1}),a(V,{span:12},{default:o(()=>[a(C,{label:"分类",prop:"category"},{default:o(()=>[a(M,{modelValue:n.category,"onUpdate:modelValue":e[6]||(e[6]=t=>n.category=t),placeholder:"请输入分类"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(L,{gutter:20},{default:o(()=>[a(V,{span:12},{default:o(()=>[a(C,{label:"状态",prop:"status"},{default:o(()=>[a(O,{modelValue:n.status,"onUpdate:modelValue":e[7]||(e[7]=t=>n.status=t),style:{width:"100%"}},{default:o(()=>[a(D,{label:"草稿",value:"DRAFT"}),a(D,{label:"已发布",value:"PUBLISHED"}),a(D,{label:"已归档",value:"ARCHIVED"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(V,{span:12},{default:o(()=>[a(C,{label:"是否公开"},{default:o(()=>[a(Ee,{modelValue:n.is_public,"onUpdate:modelValue":e[8]||(e[8]=t=>n.is_public=t)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(C,{label:"标签"},{default:o(()=>[a(M,{modelValue:R.value,"onUpdate:modelValue":e[9]||(e[9]=t=>R.value=t),placeholder:"请输入标签，用逗号分隔"},null,8,["modelValue"])]),_:1}),a(C,{label:"描述"},{default:o(()=>[a(M,{modelValue:n.description,"onUpdate:modelValue":e[10]||(e[10]=t=>n.description=t),type:"textarea",rows:3,placeholder:"请输入知识描述"},null,8,["modelValue"])]),_:1}),a(C,{label:"内容",prop:"content"},{default:o(()=>[a(M,{modelValue:n.content,"onUpdate:modelValue":e[11]||(e[11]=t=>n.content=t),type:"textarea",rows:10,placeholder:"请输入知识内容"},null,8,["modelValue"])]),_:1}),a(C,{label:"附件"},{default:o(()=>[a(Le,{ref:"uploadRef",action:ce.value,headers:pe.value,data:fe.value,"on-success":Ue,"on-error":De,"before-upload":ze,multiple:"",drag:""},{tip:o(()=>[...e[20]||(e[20]=[s("div",{class:"el-upload__tip"}," 支持 doc/docx/pdf/txt/xlsx/pptx 等格式，单个文件不超过 10MB ",-1)])]),default:o(()=>[a(h,{class:"el-icon--upload"},{default:o(()=>[a(x(ot))]),_:1}),e[21]||(e[21]=s("div",{class:"el-upload__text"},[r(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["action","headers","data"]),U.value.length>0?(u(),w("div",_t,[e[22]||(e[22]=s("h4",null,"已上传文件：",-1)),(u(!0),w(K,null,H(U.value,t=>(u(),b(A,{key:t.id,closable:"",onClose:E=>Se(t),style:{margin:"5px"}},{default:o(()=>[r(i(t.original_filename),1)]),_:2},1032,["onClose"]))),128))])):k("",!0)]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(se,{modelValue:q.value,"onUpdate:modelValue":e[14]||(e[14]=t=>q.value=t),title:"查看知识",width:"70%"},{default:o(()=>[f.value?(u(),w("div",gt,[s("h2",null,i(f.value.title),1),s("div",yt,[a(A,null,{default:o(()=>[r(i(f.value.category||"未分类"),1)]),_:1}),a(A,{type:te(f.value.status)},{default:o(()=>[r(i(le(f.value.status)),1)]),_:1},8,["type"]),s("span",wt," 创建时间："+i(ae(f.value.created_at)),1),s("span",bt," 查看次数："+i(f.value.view_count||0),1)]),f.value.description?(u(),w("div",ht,[e[24]||(e[24]=s("h4",null,"描述：",-1)),s("p",null,i(f.value.description),1)])):k("",!0),s("div",kt,[e[25]||(e[25]=s("h4",null,"内容：",-1)),s("div",Vt,i(f.value.content),1)]),f.value.files&&f.value.files.length>0?(u(),w("div",Ct,[e[26]||(e[26]=s("h4",null,"附件：",-1)),s("div",xt,[(u(!0),w(K,null,H(f.value.files,t=>(u(),w("div",{key:t.id,class:"file-item"},[a(oe,{onClick:E=>Be(t),icon:x(st)},{default:o(()=>[r(i(t.original_filename),1)]),_:2},1032,["onClick","icon"]),s("span",zt,"("+i(Fe(t.file_size))+")",1)]))),128))])])):k("",!0)])):k("",!0)]),_:1},8,["modelValue"])])}}},Ft=nt(Ut,[["__scopeId","data-v-90872e10"]]);export{Ft as default};
