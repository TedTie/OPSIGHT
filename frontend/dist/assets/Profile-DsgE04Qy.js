import{_ as W,d as X,C as P,e as S,b as B,f as Y,c as Z,a as l,k as e,j as t,h as _,x as D,o as V,p as v,t as i,l as r,i as F,q as I,E as C}from"./index-B9ntIOOh.js";import{f as j}from"./auth-pcDRQd-v.js";const $={class:"page-container"},ee={class:"user-info-header"},te={class:"user-avatar-section"},ae={class:"user-basic-info"},se={class:"user-meta"},le={class:"user-identity"},oe={class:"user-status"},ne={class:"card-header"},re={class:"stat-item"},ue={class:"stat-value"},de={class:"stat-item"},ie={class:"stat-value"},ce={class:"stat-item"},_e={class:"stat-value"},me={class:"stat-item"},pe={class:"stat-value"},fe={__name:"Profile",setup(ve){const n=X(),u=P({username:"",email:"",full_name:""}),f=P({totalTasks:0,completedTasks:0,totalReports:0,avgMood:null}),p=S(!1),k=S(!1),y=S(),L=B(()=>{const a=n.user;return a!=null&&a.full_name?a.full_name.charAt(0).toUpperCase():a!=null&&a.username?a.username.charAt(0).toUpperCase():"U"}),O=B(()=>n.isAuthenticated),q={email:[{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],full_name:[{min:1,max:50,message:"姓名长度应在1-50个字符之间",trigger:"blur"}]},R=a=>({cc:"CC(顾问)",ss:"SS(班主任)",lp:"LP(英文辅导)",sa:"SA(超级分析师)"})[a]||a||"未知",G=a=>a!=null&&a.is_super_admin?"danger":a!=null&&a.is_admin?"warning":"primary",T=a=>a?new Date(a).toLocaleString("zh-CN"):"未知",U=()=>{n.user&&(u.username=n.user.username||"",u.email=n.user.email||"",u.full_name=n.user.full_name||"")},H=async()=>{try{const s=(await D.get("/tasks/stats/summary")).data,g=(await D.get("/reports/stats/summary")).data;Object.assign(f,{totalTasks:s.total||0,completedTasks:s.done||0,totalReports:g.total_reports||0,avgMood:g.avg_emotion_score||0})}catch(a){console.error("获取用户统计失败:",a),Object.assign(f,{totalTasks:0,completedTasks:0,totalReports:0,avgMood:0})}},J=()=>{p.value?x():p.value=!0},x=()=>{var a;p.value=!1,U(),(a=y.value)==null||a.clearValidate()},K=async()=>{if(y.value)try{await y.value.validate(),k.value=!0;const a={email:u.email,full_name:u.full_name};await new Promise(s=>setTimeout(s,1e3)),await n.fetchUserInfo(),C.success("保存成功"),p.value=!1}catch(a){a.message?C.error("表单验证失败"):(C.error("保存失败"),console.error("保存失败:",a))}finally{k.value=!1}};return Y(()=>{U(),H()}),(a,s)=>{const M=_("el-avatar"),g=_("el-tag"),h=_("el-card"),w=_("el-button"),m=_("el-input"),c=_("el-form-item"),d=_("el-col"),b=_("el-row"),Q=_("el-form");return V(),Z("div",$,[s[11]||(s[11]=l("div",{class:"page-header"},[l("h1",{class:"page-title"},"个人资料"),l("p",{class:"page-description"},"查看和管理您的个人信息")],-1)),e(h,{class:"content-card user-overview"},{default:t(()=>{var o,E,A,N;return[l("div",ee,[l("div",te,[e(M,{size:80,class:"user-avatar"},{default:t(()=>[v(i(L.value),1)]),_:1}),l("div",ae,[l("h2",null,i(((o=r(n).user)==null?void 0:o.full_name)||((E=r(n).user)==null?void 0:E.username)),1),l("div",se,[e(g,{type:G(r(n).user),size:"large"},{default:t(()=>[v(i(r(j)(r(n).user)),1)]),_:1},8,["type"]),l("span",le,i(R((A=r(n).user)==null?void 0:A.identity_type)),1)])])]),l("div",oe,[e(g,{type:(N=r(n).user)!=null&&N.is_active?"success":"danger",size:"large"},{default:t(()=>{var z;return[v(i((z=r(n).user)!=null&&z.is_active?"活跃":"停用"),1)]}),_:1},8,["type"])])])]}),_:1}),e(h,{class:"content-card"},{header:t(()=>[l("div",ne,[s[3]||(s[3]=l("span",null,"基本信息",-1)),O.value?(V(),F(w,{key:0,type:"primary",size:"small",onClick:J},{default:t(()=>[v(i(p.value?"取消编辑":"编辑信息"),1)]),_:1})):I("",!0)])]),default:t(()=>[e(Q,{ref_key:"profileFormRef",ref:y,model:u,rules:q,"label-width":"120px",disabled:!p.value},{default:t(()=>[e(b,{gutter:20},{default:t(()=>[e(d,{span:12},{default:t(()=>[e(c,{label:"用户名"},{default:t(()=>[e(m,{modelValue:u.username,"onUpdate:modelValue":s[0]||(s[0]=o=>u.username=o),disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),e(d,{span:12},{default:t(()=>[e(c,{label:"邮箱",prop:"email"},{default:t(()=>[e(m,{modelValue:u.email,"onUpdate:modelValue":s[1]||(s[1]=o=>u.email=o)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(b,{gutter:20},{default:t(()=>[e(d,{span:12},{default:t(()=>[e(c,{label:"姓名",prop:"full_name"},{default:t(()=>[e(m,{modelValue:u.full_name,"onUpdate:modelValue":s[2]||(s[2]=o=>u.full_name=o)},null,8,["modelValue"])]),_:1})]),_:1}),e(d,{span:12},{default:t(()=>[e(c,{label:"角色"},{default:t(()=>[e(m,{value:r(j)(r(n).user),disabled:""},null,8,["value"])]),_:1})]),_:1})]),_:1}),e(b,{gutter:20},{default:t(()=>[e(d,{span:12},{default:t(()=>[e(c,{label:"身份"},{default:t(()=>{var o;return[e(m,{value:R((o=r(n).user)==null?void 0:o.identity_type),disabled:""},null,8,["value"])]}),_:1})]),_:1}),e(d,{span:12},{default:t(()=>[e(c,{label:"所属组别"},{default:t(()=>{var o;return[e(m,{value:((o=r(n).user)==null?void 0:o.group_name)||"未分配",disabled:""},null,8,["value"])]}),_:1})]),_:1})]),_:1}),e(b,{gutter:20},{default:t(()=>[e(d,{span:12},{default:t(()=>[e(c,{label:"创建时间"},{default:t(()=>{var o;return[e(m,{value:T((o=r(n).user)==null?void 0:o.created_at),disabled:""},null,8,["value"])]}),_:1})]),_:1}),e(d,{span:12},{default:t(()=>[e(c,{label:"最后更新"},{default:t(()=>{var o;return[e(m,{value:T((o=r(n).user)==null?void 0:o.updated_at),disabled:""},null,8,["value"])]}),_:1})]),_:1})]),_:1}),p.value?(V(),F(c,{key:0},{default:t(()=>[e(w,{type:"primary",onClick:K,loading:k.value},{default:t(()=>[...s[4]||(s[4]=[v(" 保存修改 ",-1)])]),_:1},8,["loading"]),e(w,{onClick:x},{default:t(()=>[...s[5]||(s[5]=[v("取消",-1)])]),_:1})]),_:1})):I("",!0)]),_:1},8,["model","disabled"])]),_:1}),e(h,{class:"content-card"},{header:t(()=>[...s[6]||(s[6]=[l("div",{class:"card-header"},[l("span",null,"个人统计")],-1)])]),default:t(()=>[e(b,{gutter:20,class:"stats-row"},{default:t(()=>[e(d,{span:6},{default:t(()=>[l("div",re,[l("div",ue,i(f.totalTasks),1),s[7]||(s[7]=l("div",{class:"stat-label"},"总任务数",-1))])]),_:1}),e(d,{span:6},{default:t(()=>[l("div",de,[l("div",ie,i(f.completedTasks),1),s[8]||(s[8]=l("div",{class:"stat-label"},"已完成任务",-1))])]),_:1}),e(d,{span:6},{default:t(()=>[l("div",ce,[l("div",_e,i(f.totalReports),1),s[9]||(s[9]=l("div",{class:"stat-label"},"日报总数",-1))])]),_:1}),e(d,{span:6},{default:t(()=>[l("div",me,[l("div",pe,i(f.avgMood||"N/A"),1),s[10]||(s[10]=l("div",{class:"stat-label"},"平均情绪值",-1))])]),_:1})]),_:1})]),_:1})])}}},ye=W(fe,[["__scopeId","data-v-85582fca"]]);export{ye as default};
