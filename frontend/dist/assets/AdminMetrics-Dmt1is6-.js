import{_ as _e,e as _,b as O,f as ge,x as y,E as A,c as I,a as v,k as l,j as n,h,A as ve,o as p,F as E,r as T,i as w,p as j,B as se,t as ye,q as L}from"./index-D85A-Gbf.js";const fe={class:"page-container"},be={class:"card-header"},he={class:"header-actions"},we={class:"goal-form"},Ve={class:"card-header"},Ce={class:"header-actions"},Se={class:"filters-bar"},Ae={class:"card-header"},Ue={class:"header-actions"},Me={__name:"AdminMetrics",setup(ke){const Z=_("goals"),R=new Date,$=R.getFullYear(),ee=R.getMonth()+1,ae=O(()=>[$-1,$,$+1]),te=O(()=>Array.from({length:12},(t,e)=>e+1)),B=_($),P=_(ee),U=_(""),M=_(""),k=_(""),H=_(!1),F=_(""),ue=O(()=>{const t=Number(U.value||0)+Number(M.value||0),e=Number(k.value||0);return(t+e).toFixed(0)}),J=_(!1),le=_([]),Y=_(""),de=O(()=>{let t=le.value||[];if(Y.value){const e=Y.value.toLowerCase();t=t.filter(r=>(r.name||"").toLowerCase().includes(e)||(r.key||"").toLowerCase().includes(e))}return t});ge(()=>{Q(),oe(),re()});async function Q(){try{const{data:t}=await y.get("/goals/monthly",{params:{year:B.value,month:P.value,scope:"global"}}),e=Array.isArray(t)?t:(t==null?void 0:t.items)||[],r=e.find(m=>String(m.identity_type||"").toUpperCase()==="CC"&&String(m.scope||"").toLowerCase()==="global"),i=e.find(m=>String(m.identity_type||"").toUpperCase()==="SS"&&String(m.scope||"").toLowerCase()==="global");U.value=(r==null?void 0:r.new_sign_target_amount)??"",M.value=(r==null?void 0:r.referral_target_amount)??"",k.value=(i==null?void 0:i.renewal_total_target_amount)??"",F.value=(i==null?void 0:i.upgrade_target_count)??""}catch{U.value="",M.value="",k.value="",F.value=""}}async function ie(){H.value=!0;try{const t=B.value,e=P.value,r={identity_type:"CC",scope:"global",year:t,month:e,amount_target:Number(U.value||0)+Number(M.value||0),new_sign_target_amount:Number(U.value||0),referral_target_amount:Number(M.value||0)};await y.post("/goals/monthly",r);const i={identity_type:"SS",scope:"global",year:t,month:e,amount_target:Number(k.value||0),renewal_total_target_amount:Number(k.value||0),upgrade_target_count:Number(F.value||0)};await y.post("/goals/monthly",i),A.success("月度目标已保存")}catch{A.error("保存月度目标失败")}finally{H.value=!1}}async function oe(){J.value=!0;try{const{data:t}=await y.get("/admin/metrics");le.value=Array.isArray(t)?t:(t==null?void 0:t.items)||[]}catch{A.error("获取指标库失败")}finally{J.value=!1}}const V=_("CC"),q=_($),z=_(ee),N=_(null),C=_([]),W=_(!1),X=_(!1),x=_([]);async function re(){var t,e,r,i;try{const{data:m}=await y.get("/users",{params:{page:1,size:500},suppressErrorMessage:!0}),s=Array.isArray(m==null?void 0:m.items)?m.items:[],c=String(V.value||"").toUpperCase();let S=s.filter(u=>String(u.identity_type||"").toUpperCase()===c&&u.group_id!=null);if(S.length){const u=new Map;for(const o of S){const d=String(o.group_id);u.has(d)||u.set(d,{id:o.group_id,name:o.group_name||`组${d}`})}C.value=Array.from(u.values())}else{const u=await y.get("/groups",{suppressErrorMessage:!0}),o=Array.isArray((t=u==null?void 0:u.data)==null?void 0:t.items)?u.data.items:Array.isArray(u==null?void 0:u.data)?u.data:[],d=[];for(const g of o)try{const f=await y.get(`/groups/${g.id}/members`,{suppressErrorMessage:!0});(Array.isArray((e=f==null?void 0:f.data)==null?void 0:e.items)?f.data.items:Array.isArray(f==null?void 0:f.data)?f.data:[]).some(K=>String(K.identity_type||"").toUpperCase()===c)&&d.push({id:g.id,name:g.name||`组${g.id}`})}catch{}C.value=d}N.value=C.value.length?C.value[0].id:null,await D()}catch{try{const m=String(V.value||"").toUpperCase(),s=await y.get("/groups",{suppressErrorMessage:!0}),c=Array.isArray((r=s==null?void 0:s.data)==null?void 0:r.items)?s.data.items:Array.isArray(s==null?void 0:s.data)?s.data:[],S=[];for(const u of c)try{const o=await y.get(`/groups/${u.id}/members`,{suppressErrorMessage:!0});(Array.isArray((i=o==null?void 0:o.data)==null?void 0:i.items)?o.data.items:Array.isArray(o==null?void 0:o.data)?o.data:[]).some(f=>String(f.identity_type||"").toUpperCase()===m)&&S.push({id:u.id,name:u.name||`组${u.id}`})}catch{}C.value=S,N.value=C.value.length?C.value[0].id:null,await D()}catch{C.value=[],N.value=null,x.value=[]}}}function me(t){const e=Number(t.new_sign_target_amount||0),r=Number(t.referral_target_amount||0);return(e+r).toFixed(0)}async function D(){var t,e,r,i;W.value=!0;try{const m=N.value;if(!m){x.value=[];return}let s=[];try{const o=await y.get(`/groups/${m}/members`);s=Array.isArray((t=o==null?void 0:o.data)==null?void 0:t.items)?o.data.items:Array.isArray(o==null?void 0:o.data)?o.data:[]}catch(o){((e=o==null?void 0:o.response)==null?void 0:e.status)===403&&A.warning("权限不足：无法查看该组织成员（需要管理员或超级管理员）");try{const g=await y.get("/users",{params:{page:1,size:500},suppressErrorMessage:!0});s=(Array.isArray((r=g==null?void 0:g.data)==null?void 0:r.items)?g.data.items:[]).filter(G=>String(G.group_id)===String(m))}catch{}}const c=await y.get("/goals/monthly",{params:{identity_type:V.value,scope:"user",group_id:m,year:q.value,month:z.value},suppressErrorMessage:!0}),S=Array.isArray(c==null?void 0:c.data)?c.data:Array.isArray((i=c==null?void 0:c.data)==null?void 0:i.items)?c.data.items:[],u=new Map(S.map(o=>[String(o.user_id),o]));x.value=s.map(o=>{const d=o.id??o.user_id,g=u.get(String(d))||{};return{user_id:d,username:o.username||o.name||o.email||`用户${d}`,new_sign_target_amount:g.new_sign_target_amount??"",referral_target_amount:g.referral_target_amount??"",renewal_total_target_amount:g.renewal_total_target_amount??"",upgrade_target_count:g.upgrade_target_count??""}})}catch{x.value=[]}finally{W.value=!1}}async function pe(){var t;X.value=!0;try{const e=x.value.map(r=>({identity_type:V.value,scope:"user",group_id:N.value,user_id:r.user_id,year:q.value,month:z.value,new_sign_target_amount:Number(r.new_sign_target_amount||0),referral_target_amount:Number(r.referral_target_amount||0),renewal_total_target_amount:Number(r.renewal_total_target_amount||0),upgrade_target_count:Number(r.upgrade_target_count||0)}));await Promise.all(e.map(r=>y.post("/goals/monthly",r))),A.success("个人目标已批量保存"),D()}catch(e){((t=e==null?void 0:e.response)==null?void 0:t.status)===403?A.error("保存失败：需要管理员或超级管理员权限"):A.error("保存个人目标失败")}finally{X.value=!1}}async function ce(t){const e=!!t.is_active;t.__saving=!0;try{if(!t.id)throw new Error("缺少指标ID");await y.put(`/admin/metrics/${t.id}`,{is_active:t.is_active}),A.success("已更新启用状态")}catch{t.is_active=e,A.error("更新启用状态失败")}finally{t.__saving=!1}}return(t,e)=>{const r=h("el-option"),i=h("el-select"),m=h("el-button"),s=h("el-input"),c=h("el-form-item"),S=h("el-form"),u=h("el-card"),o=h("el-tab-pane"),d=h("el-table-column"),g=h("el-switch"),f=h("el-tag"),G=h("el-table"),ne=h("el-tabs"),K=ve("loading");return p(),I("div",fe,[e[18]||(e[18]=v("div",{class:"page-header"},[v("h1",{class:"page-title"},"指标管理"),v("p",{class:"page-description"},"月度目标与指标库管理")],-1)),l(ne,{modelValue:Z.value,"onUpdate:modelValue":e[11]||(e[11]=a=>Z.value=a)},{default:n(()=>[l(o,{label:"月度目标设置",name:"goals"},{default:n(()=>[l(u,{class:"content-card"},{header:n(()=>[v("div",be,[e[13]||(e[13]=v("span",null,"月度目标设置（含细分目标）",-1)),v("div",he,[l(i,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=a=>B.value=a),placeholder:"年份",style:{width:"120px"},onChange:Q},{default:n(()=>[(p(!0),I(E,null,T(ae.value,a=>(p(),w(r,{key:a,label:String(a),value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(i,{modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=a=>P.value=a),placeholder:"月份",style:{width:"120px"},onChange:Q},{default:n(()=>[(p(!0),I(E,null,T(te.value,a=>(p(),w(r,{key:a,label:String(a),value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(m,{type:"primary",loading:H.value,onClick:ie},{default:n(()=>[...e[12]||(e[12]=[j("保存",-1)])]),_:1},8,["loading"])])])]),default:n(()=>[v("div",we,[l(S,{"label-width":"160px"},{default:n(()=>[l(c,{label:"新单目标金额 (USD)"},{default:n(()=>[l(s,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=a=>U.value=a),placeholder:"请输入本月新单目标金额"},null,8,["modelValue"])]),_:1}),l(c,{label:"转介绍目标金额 (USD)"},{default:n(()=>[l(s,{modelValue:M.value,"onUpdate:modelValue":e[3]||(e[3]=a=>M.value=a),placeholder:"请输入本月转介绍目标金额"},null,8,["modelValue"])]),_:1}),l(c,{label:"总续费目标金额 (USD)"},{default:n(()=>[l(s,{modelValue:k.value,"onUpdate:modelValue":e[4]||(e[4]=a=>k.value=a),placeholder:"请输入本月总续费目标金额（含续费+升舱金额）"},null,8,["modelValue"])]),_:1}),l(c,{label:"升舱人数目标 (人)"},{default:n(()=>[l(s,{modelValue:F.value,"onUpdate:modelValue":e[5]||(e[5]=a=>F.value=a),placeholder:"请输入本月升舱人数目标"},null,8,["modelValue"])]),_:1}),l(c,{label:"销售总目标 (自动汇总)"},{default:n(()=>[l(s,{"model-value":ue.value,disabled:""},null,8,["model-value"])]),_:1})]),_:1})])]),_:1})]),_:1}),l(o,{label:"指标库管理",name:"library"},{default:n(()=>[l(u,{class:"content-card"},{header:n(()=>[v("div",Ve,[e[15]||(e[15]=v("span",null,"系统指标库",-1)),v("div",Ce,[l(m,{onClick:oe},{default:n(()=>[...e[14]||(e[14]=[j("刷新",-1)])]),_:1})])])]),default:n(()=>[v("div",Se,[l(s,{modelValue:Y.value,"onUpdate:modelValue":e[6]||(e[6]=a=>Y.value=a),placeholder:"搜索名称或Key",clearable:"",style:{width:"240px"}},null,8,["modelValue"])]),se((p(),w(G,{data:de.value,border:"",stripe:"",style:{width:"100%"}},{default:n(()=>[l(d,{prop:"name",label:"名称","min-width":"200"}),l(d,{prop:"key",label:"Key","min-width":"220"}),l(d,{label:"启用",width:"140"},{default:n(a=>[l(g,{modelValue:a.row.is_active,"onUpdate:modelValue":b=>a.row.is_active=b,loading:a.row.__saving,onChange:b=>ce(a.row)},null,8,["modelValue","onUpdate:modelValue","loading","onChange"])]),_:1}),l(d,{prop:"default_roles",label:"默认角色","min-width":"160"},{default:n(a=>[(p(!0),I(E,null,T(a.row.default_roles||[],b=>(p(),w(f,{key:b,size:"small",style:{"margin-right":"6px"}},{default:n(()=>[j(ye(b),1)]),_:2},1024))),128))]),_:1})]),_:1},8,["data"])),[[K,J.value]])]),_:1})]),_:1}),l(o,{label:"个人目标设置",name:"personal"},{default:n(()=>[l(u,{class:"content-card"},{header:n(()=>[v("div",Ae,[e[17]||(e[17]=v("span",null,"个人目标设置（按身份→组织→年月）",-1)),v("div",Ue,[l(i,{modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=a=>V.value=a),placeholder:"身份",style:{width:"140px"},onChange:re},{default:n(()=>[l(r,{label:"CC(顾问)",value:"CC"}),l(r,{label:"SS(班主任)",value:"SS"})]),_:1},8,["modelValue"]),l(i,{modelValue:N.value,"onUpdate:modelValue":e[8]||(e[8]=a=>N.value=a),placeholder:"组织",style:{width:"160px"},onChange:D},{default:n(()=>[(p(!0),I(E,null,T(C.value,a=>(p(),w(r,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(i,{modelValue:q.value,"onUpdate:modelValue":e[9]||(e[9]=a=>q.value=a),placeholder:"年份",style:{width:"110px"},onChange:D},{default:n(()=>[(p(!0),I(E,null,T(ae.value,a=>(p(),w(r,{key:a,label:String(a),value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(i,{modelValue:z.value,"onUpdate:modelValue":e[10]||(e[10]=a=>z.value=a),placeholder:"月份",style:{width:"110px"},onChange:D},{default:n(()=>[(p(!0),I(E,null,T(te.value,a=>(p(),w(r,{key:a,label:String(a),value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(m,{type:"primary",loading:X.value,onClick:pe},{default:n(()=>[...e[16]||(e[16]=[j("批量保存",-1)])]),_:1},8,["loading"])])])]),default:n(()=>[v("div",null,[se((p(),w(G,{data:x.value,border:"",stripe:"",style:{width:"100%"}},{default:n(()=>[l(d,{prop:"username",label:"用户","min-width":"160"}),V.value==="CC"?(p(),w(d,{key:0,label:"新单目标金额(USD)","min-width":"180"},{default:n(({row:a})=>[l(s,{modelValue:a.new_sign_target_amount,"onUpdate:modelValue":b=>a.new_sign_target_amount=b,placeholder:"输入金额"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):L("",!0),V.value==="CC"?(p(),w(d,{key:1,label:"转介绍目标金额(USD)","min-width":"180"},{default:n(({row:a})=>[l(s,{modelValue:a.referral_target_amount,"onUpdate:modelValue":b=>a.referral_target_amount=b,placeholder:"输入金额"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):L("",!0),V.value==="CC"?(p(),w(d,{key:2,label:"销售总目标(自动)",width:"160"},{default:n(({row:a})=>[l(s,{"model-value":me(a),disabled:""},null,8,["model-value"])]),_:1})):L("",!0),V.value==="SS"?(p(),w(d,{key:3,label:"总续费目标金额(USD)","min-width":"190"},{default:n(({row:a})=>[l(s,{modelValue:a.renewal_total_target_amount,"onUpdate:modelValue":b=>a.renewal_total_target_amount=b,placeholder:"输入金额"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):L("",!0),V.value==="SS"?(p(),w(d,{key:4,label:"升舱人数目标(人)",width:"160"},{default:n(({row:a})=>[l(s,{modelValue:a.upgrade_target_count,"onUpdate:modelValue":b=>a.upgrade_target_count=b,placeholder:"输入人数"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):L("",!0)]),_:1},8,["data"])),[[K,W.value]])])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Ie=_e(Me,[["__scopeId","data-v-9e2b485a"]]);export{Ie as default};
