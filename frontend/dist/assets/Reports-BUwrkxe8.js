import{r as f,L,o as be,l as g,f as o,g as l,w as s,b as _,P as b,E as d,Q as Z,e as u,U as C,h as Y,X as he,Y as Ie,k as m,d as v,t as p,m as w,V as ze,F as ee,n as te,y as ae}from"./index-g0Sg6k74.js";import{f as G,a as Ce}from"./date-CxVpZo2G.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Te={class:"page-container"},Ue={class:"card-header"},De={class:"table-toolbar"},Ye={class:"table-filters"},$e={class:"table-actions"},Ae={key:1,class:"text-muted"},Me={class:"pagination-container"},Se={class:"completed-tasks-section"},Be={class:"task-selector"},Ee={style:{float:"left"}},Fe={style:{float:"right",color:"#8492a6","font-size":"13px"}},je={class:"dialog-footer"},qe={key:0,class:"report-detail"},Oe={class:"report-header"},Pe={class:"report-meta"},Ne={class:"report-section"},Ke={class:"report-section"},Le={key:0,class:"report-section"},Ge={class:"report-section"},Qe={key:1,class:"report-section"},We={class:"ai-analysis"},Xe={class:"ai-analysis-header"},He={class:"analysis-model"},Je={key:0,class:"analysis-item"},Ze={key:1,class:"analysis-item"},et={key:2,class:"analysis-item"},tt={key:3,class:"analysis-item"},at={key:4,class:"analysis-item"},lt={class:"keywords-container"},st={class:"analysis-meta"},ot={class:"processing-time"},nt={__name:"Reports",setup(rt){const U=f(!1),$=f([]),S=f([]),x=L({dateRange:[],search:""}),h=L({page:1,size:20,total:0}),D=f(!1),F=f(!1),R=f(!1),j=f(!1),A=f(),r=f(null),i=L({report_date:"",summary:"",completed_tasks:"",issues_encountered:"",next_day_plan:"",work_hours:8,mood_score:3,call_count:0,call_duration:0}),q=f([]),B=f([]),O=f(!1),P=f(!1),N=f(!1),le={report_date:[{required:!0,message:"请选择日报日期",trigger:"change"}],summary:[{required:!0,message:"请输入工作摘要",trigger:"blur"},{min:10,max:500,message:"摘要长度在 10 到 500 个字符",trigger:"blur"}],completed_tasks:[{required:!0,message:"请输入完成的任务",trigger:"blur"}],next_day_plan:[{required:!0,message:"请输入明日计划",trigger:"blur"}],work_hours:[{required:!0,message:"请输入工作时长",trigger:"blur"}]},Q=a=>a>=.7?"success":a>=.3?"warning":"danger",se=a=>({pending:"待处理",processing:"进行中",done:"已完成"})[a]||a,W=async()=>{O.value=!0;try{const a=await b.get("/tasks",{params:{assigned_to_me:!0,status:"done",limit:100}});q.value=a.data||[]}catch{d.error("获取任务列表失败")}finally{O.value=!1}},oe=()=>{const a=q.value.filter(e=>B.value.includes(e.id));if(a.length>0){const e=a.map(c=>`• ${c.title}`).join(`
`),n=i.completed_tasks||"";!n||n.startsWith("• ")?i.completed_tasks=e:i.completed_tasks=e+`

`+n}},I=async()=>{U.value=!0;try{const a={page:h.page,size:h.size,...x};x.dateRange&&x.dateRange.length===2&&(a.start_date=x.dateRange[0],a.end_date=x.dateRange[1]);const e=await b.get("/reports",{params:a});$.value=e.data.items||[],h.total=e.data.total||0}catch{d.error("获取日报列表失败")}finally{U.value=!1}},ne=()=>{R.value=!1,i.report_date=new Date().toISOString().split("T")[0],D.value=!0,W()},re=a=>{r.value=a,F.value=!0},ie=a=>{R.value=!0,Object.assign(i,{id:parseInt(a.id),report_date:a.report_date,summary:a.summary,completed_tasks:a.completed_tasks,issues_encountered:a.issues_encountered||"",next_day_plan:a.next_day_plan,work_hours:a.work_hours,mood_score:a.mood_score,call_count:a.call_count||0,call_duration:a.call_duration||0}),D.value=!0},de=()=>{A.value&&A.value.resetFields(),Object.assign(i,{report_date:"",summary:"",completed_tasks:"",issues_encountered:"",next_day_plan:"",work_hours:8,mood_score:3,call_count:0,call_duration:0}),B.value=[]},ue=async()=>{var a,e;if(A.value)try{await A.value.validate(),j.value=!0,R.value?(await b.put(`/reports/${i.id}`,i),d.success("日报更新成功")):(await b.post("/reports",i),d.success("日报提交成功")),D.value=!1,I()}catch(n){(e=(a=n.response)==null?void 0:a.data)!=null&&e.detail?d.error(n.response.data.detail):d.error(R.value?"更新失败":"提交失败")}finally{j.value=!1}},pe=async a=>{try{await ae.confirm(`确定要删除${G(a.report_date)}的日报吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await b.delete(`/reports/${parseInt(a.id)}`),d.success("删除成功"),I()}catch(e){e!=="cancel"&&d.error("删除失败")}},ce=async a=>{var e,n;try{S.value.push(parseInt(a.id));const c=await b.post(`/ai/analyze-report/${parseInt(a.id)}`);if(c.data.success){d.success("AI分析完成");const y=$.value.findIndex(k=>parseInt(k.id)===parseInt(a.id));y!==-1&&($.value[y].ai_result=c.data.ai_result)}else d.warning(c.data.message||"AI分析失败")}catch(c){console.error("AI分析错误:",c),(n=(e=c.response)==null?void 0:e.data)!=null&&n.detail?d.error(c.response.data.detail):d.error("AI分析失败，请稍后重试")}finally{const c=S.value.indexOf(parseInt(a.id));c>-1&&S.value.splice(c,1)}},me=async()=>{var a,e;try{const n=$.value.filter(k=>!k.ai_result);if(n.length===0){d.info("所有日报都已完成AI分析");return}await ae.confirm(`确定要对${n.length}个未分析的日报进行批量AI分析吗？`,"批量AI分析",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),U.value=!0;const c=n.map(k=>parseInt(k.id)),y=await b.post("/ai/batch-analyze",{report_ids:c});y.data.success?(d.success(`批量分析已启动，正在处理${c.length}个日报`),setTimeout(()=>{I()},2e3)):d.warning(y.data.message||"批量分析启动失败")}catch(n){n!=="cancel"&&(console.error("批量AI分析错误:",n),(e=(a=n.response)==null?void 0:a.data)!=null&&e.detail?d.error(n.response.data.detail):d.error("批量分析失败，请稍后重试"))}finally{U.value=!1}},_e=async()=>{if(!i.report_date){d.warning("请先选择日报日期");return}P.value=!0;try{const a=await b.get("/task-sync/daily-task-summary",{params:{date:i.report_date}});if(a.data&&a.data.length>0){const e=a.data.map(n=>`${n.title}: ${n.completion_data||"已完成"}`).join(`
`);i.completed_tasks=e,d.success(`已加载${a.data.length}个任务完成记录`)}else d.info("该日期没有任务完成记录")}catch(a){console.error("加载任务汇总失败:",a),d.error("加载任务汇总失败")}finally{P.value=!1}},fe=async()=>{var a,e;N.value=!0;try{const n=new Date().toISOString().split("T")[0],c=await b.post("/task-sync/auto-generate-daily-report",{date:n});c.data.success?(d.success("自动生成日报成功"),I()):d.warning(c.data.message||"自动生成日报失败")}catch(n){console.error("自动生成日报失败:",n),(e=(a=n.response)==null?void 0:a.data)!=null&&e.detail?d.error(n.response.data.detail):d.error("自动生成日报失败")}finally{N.value=!1}};return be(()=>{I()}),(a,e)=>{const n=_("el-button"),c=_("el-date-picker"),y=_("el-input"),k=_("el-table-column"),M=_("el-tag"),ge=_("el-table"),ve=_("el-pagination"),ye=_("el-card"),V=_("el-form-item"),ke=_("el-option"),we=_("el-select"),K=_("el-input-number"),E=_("el-col"),X=_("el-rate"),H=_("el-row"),xe=_("el-form"),J=_("el-dialog"),T=Z("can"),Ve=Z("loading");return u(),g("div",Te,[e[40]||(e[40]=o("div",{class:"page-header"},[o("h1",{class:"page-title"},"日报管理"),o("p",{class:"page-description"},"查看和管理您的日报")],-1)),l(ye,{class:"content-card"},{header:s(()=>[o("div",Ue,[e[19]||(e[19]=o("span",null,"日报列表",-1)),C((u(),v(n,{type:"primary",icon:Y(ze),onClick:ne},{default:s(()=>[...e[18]||(e[18]=[m(" 写日报 ",-1)])]),_:1},8,["icon"])),[[T,"reports:create"]])])]),default:s(()=>[o("div",De,[o("div",Ye,[l(c,{modelValue:x.dateRange,"onUpdate:modelValue":e[0]||(e[0]=t=>x.dateRange=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"]),l(y,{modelValue:x.search,"onUpdate:modelValue":e[1]||(e[1]=t=>x.search=t),placeholder:"搜索日报...","prefix-icon":Y(he),clearable:""},null,8,["modelValue","prefix-icon"])]),o("div",$e,[l(n,{icon:Y(Ie),onClick:I},{default:s(()=>[...e[20]||(e[20]=[m("刷新",-1)])]),_:1},8,["icon"]),C((u(),v(n,{type:"info",onClick:fe,loading:N.value},{default:s(()=>[...e[21]||(e[21]=[m(" 自动生成今日日报 ",-1)])]),_:1},8,["loading"])),[[T,"reports:auto_generate"]]),C((u(),v(n,{type:"success",onClick:me,loading:U.value},{default:s(()=>[...e[22]||(e[22]=[m(" 批量AI分析 ",-1)])]),_:1},8,["loading"])),[[T,"reports:analyze:batch"]])])]),C((u(),v(ge,{data:$.value,stripe:"",style:{width:"100%"}},{default:s(()=>[l(k,{prop:"report_date",label:"日期",width:"120"},{default:s(({row:t})=>[m(p(Y(G)(t.report_date)),1)]),_:1}),l(k,{prop:"summary",label:"摘要","min-width":"300"}),l(k,{label:"AI分析",width:"120"},{default:s(({row:t})=>[t.ai_result?(u(),v(M,{key:0,type:Q(t.ai_result.emotion_score),size:"small"},{default:s(()=>[m(p(t.ai_result.emotion_score),1)]),_:2},1032,["type"])):(u(),g("span",Ae,"未分析"))]),_:1}),l(k,{prop:"created_at",label:"创建时间",width:"180"},{default:s(({row:t})=>[m(p(Y(Ce)(t.created_at)),1)]),_:1}),l(k,{label:"操作",width:"200",fixed:"right"},{default:s(({row:t})=>[C((u(),v(n,{type:"primary",size:"small",onClick:z=>re(t)},{default:s(()=>[...e[23]||(e[23]=[m(" 查看 ",-1)])]),_:1},8,["onClick"])),[[T,t,"report",{view:!0}]]),C((u(),v(n,{type:"warning",size:"small",onClick:z=>ie(t)},{default:s(()=>[...e[24]||(e[24]=[m(" 编辑 ",-1)])]),_:1},8,["onClick"])),[[T,t,"report",{edit:!0}]]),t.ai_result?w("",!0):C((u(),v(n,{key:0,type:"success",size:"small",onClick:z=>ce(t),loading:S.value.includes(t.id)},{default:s(()=>[...e[25]||(e[25]=[m(" AI分析 ",-1)])]),_:1},8,["onClick","loading"])),[[T,"reports:analyze"]]),C((u(),v(n,{type:"danger",size:"small",onClick:z=>pe(t)},{default:s(()=>[...e[26]||(e[26]=[m(" 删除 ",-1)])]),_:1},8,["onClick"])),[[T,t,"report",{delete:!0}]])]),_:1})]),_:1},8,["data"])),[[Ve,U.value]]),o("div",Me,[l(ve,{"current-page":h.page,"onUpdate:currentPage":e[2]||(e[2]=t=>h.page=t),"page-size":h.size,"onUpdate:pageSize":e[3]||(e[3]=t=>h.size=t),total:h.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:I,onCurrentChange:I},null,8,["current-page","page-size","total"])])]),_:1}),l(J,{modelValue:D.value,"onUpdate:modelValue":e[15]||(e[15]=t=>D.value=t),title:R.value?"编辑日报":"写日报",width:"800px",onClose:de},{footer:s(()=>[o("span",je,[l(n,{onClick:e[14]||(e[14]=t=>D.value=!1)},{default:s(()=>[...e[29]||(e[29]=[m("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:ue,loading:j.value},{default:s(()=>[m(p(R.value?"更新":"提交"),1)]),_:1},8,["loading"])])]),default:s(()=>[l(xe,{ref_key:"formRef",ref:A,model:i,rules:le,"label-width":"100px"},{default:s(()=>[l(V,{label:"日报日期",prop:"report_date"},{default:s(()=>[l(c,{modelValue:i.report_date,"onUpdate:modelValue":e[4]||(e[4]=t=>i.report_date=t),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",disabled:R.value},null,8,["modelValue","disabled"])]),_:1}),l(V,{label:"工作摘要",prop:"summary"},{default:s(()=>[l(y,{modelValue:i.summary,"onUpdate:modelValue":e[5]||(e[5]=t=>i.summary=t),type:"textarea",rows:3,placeholder:"请简要描述今日工作内容",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),l(V,{label:"完成任务",prop:"completed_tasks"},{default:s(()=>[o("div",Se,[o("div",Be,[l(we,{modelValue:B.value,"onUpdate:modelValue":e[6]||(e[6]=t=>B.value=t),multiple:"",placeholder:"选择今日完成的任务",style:{width:"100%","margin-bottom":"10px"},onChange:oe},{default:s(()=>[(u(!0),g(ee,null,te(q.value,t=>(u(),v(ke,{key:t.id,label:t.title,value:t.id},{default:s(()=>[o("span",Ee,p(t.title),1),o("span",Fe,p(se(t.status)),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]),l(n,{type:"primary",size:"small",onClick:W,loading:O.value},{default:s(()=>[...e[27]||(e[27]=[m(" 刷新任务列表 ",-1)])]),_:1},8,["loading"]),l(n,{type:"success",size:"small",onClick:_e,loading:P.value,style:{"margin-left":"10px"}},{default:s(()=>[...e[28]||(e[28]=[m(" 加载任务完成汇总 ",-1)])]),_:1},8,["loading"])]),l(y,{modelValue:i.completed_tasks,"onUpdate:modelValue":e[7]||(e[7]=t=>i.completed_tasks=t),type:"textarea",rows:3,placeholder:"补充描述完成任务的详细情况或其他工作内容",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])])]),_:1}),l(V,{label:"遇到问题",prop:"issues_encountered"},{default:s(()=>[l(y,{modelValue:i.issues_encountered,"onUpdate:modelValue":e[8]||(e[8]=t=>i.issues_encountered=t),type:"textarea",rows:3,placeholder:"描述工作中遇到的问题和困难",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),_:1}),l(V,{label:"明日计划",prop:"next_day_plan"},{default:s(()=>[l(y,{modelValue:i.next_day_plan,"onUpdate:modelValue":e[9]||(e[9]=t=>i.next_day_plan=t),type:"textarea",rows:3,placeholder:"描述明日的工作计划",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),_:1}),l(H,{gutter:20},{default:s(()=>[l(E,{span:12},{default:s(()=>[l(V,{label:"工作时长",prop:"work_hours"},{default:s(()=>[l(K,{modelValue:i.work_hours,"onUpdate:modelValue":e[10]||(e[10]=t=>i.work_hours=t),min:0,max:24,step:.5,placeholder:"工作时长（小时）"},null,8,["modelValue"])]),_:1})]),_:1}),l(E,{span:12},{default:s(()=>[l(V,{label:"心情评分",prop:"mood_score"},{default:s(()=>[l(X,{modelValue:i.mood_score,"onUpdate:modelValue":e[11]||(e[11]=t=>i.mood_score=t),max:5,"show-text":"",texts:["很差","较差","一般","较好","很好"]},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(H,{gutter:20},{default:s(()=>[l(E,{span:12},{default:s(()=>[l(V,{label:"KPI 通次",prop:"call_count"},{default:s(()=>[l(K,{modelValue:i.call_count,"onUpdate:modelValue":e[12]||(e[12]=t=>i.call_count=t),min:0,step:1,placeholder:"今日拨打次数"},null,8,["modelValue"])]),_:1})]),_:1}),l(E,{span:12},{default:s(()=>[l(V,{label:"KPI 通时",prop:"call_duration"},{default:s(()=>[l(K,{modelValue:i.call_duration,"onUpdate:modelValue":e[13]||(e[13]=t=>i.call_duration=t),min:0,step:1,placeholder:"拨打总时长（分钟）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(J,{modelValue:F.value,"onUpdate:modelValue":e[17]||(e[17]=t=>F.value=t),title:"查看日报",width:"800px"},{default:s(()=>{var t;return[r.value?(u(),g("div",qe,[o("div",Oe,[o("h3",null,p(Y(G)(r.value.report_date))+" 日报",1),o("div",Pe,[l(M,null,{default:s(()=>[m("工作时长: "+p(r.value.work_hours)+"小时",1)]),_:1}),r.value.call_count!==void 0&&r.value.call_duration!==void 0?(u(),v(M,{key:0,type:"success"},{default:s(()=>[m(" KPI 通次/通时: "+p(r.value.call_count)+"/"+p(r.value.call_duration),1)]),_:1})):w("",!0),l(X,{modelValue:r.value.mood_score,"onUpdate:modelValue":e[16]||(e[16]=z=>r.value.mood_score=z),max:5,disabled:"","show-text":"",texts:["很差","较差","一般","较好","很好"]},null,8,["modelValue"])])]),o("div",Ne,[e[30]||(e[30]=o("h4",null,"工作摘要",-1)),o("p",null,p(r.value.summary),1)]),o("div",Ke,[e[31]||(e[31]=o("h4",null,"完成任务",-1)),o("p",null,p(r.value.completed_tasks),1)]),r.value.issues_encountered?(u(),g("div",Le,[e[32]||(e[32]=o("h4",null,"遇到问题",-1)),o("p",null,p(r.value.issues_encountered),1)])):w("",!0),o("div",Ge,[e[33]||(e[33]=o("h4",null,"明日计划",-1)),o("p",null,p(r.value.next_day_plan),1)]),r.value.ai_result?(u(),g("div",Qe,[e[39]||(e[39]=o("h4",null,"AI分析结果",-1)),o("div",We,[o("div",Xe,[l(M,{type:Q(r.value.ai_result.emotion_score),size:"large"},{default:s(()=>[m(" 情感评分: "+p(r.value.ai_result.emotion_score),1)]),_:1},8,["type"]),o("span",He," 模型: "+p(r.value.ai_result.model_used),1)]),r.value.ai_result.emotion_analysis?(u(),g("div",Je,[e[34]||(e[34]=o("h5",null,"情感分析",-1)),o("p",null,p(r.value.ai_result.emotion_analysis),1)])):w("",!0),r.value.ai_result.summary?(u(),g("div",Ze,[e[35]||(e[35]=o("h5",null,"工作摘要",-1)),o("p",null,p(r.value.ai_result.summary),1)])):w("",!0),r.value.ai_result.reflection?(u(),g("div",et,[e[36]||(e[36]=o("h5",null,"反思与总结",-1)),o("p",null,p(r.value.ai_result.reflection),1)])):w("",!0),r.value.ai_result.suggestions?(u(),g("div",tt,[e[37]||(e[37]=o("h5",null,"改进建议",-1)),o("p",null,p(r.value.ai_result.suggestions),1)])):w("",!0),r.value.ai_result.keywords&&r.value.ai_result.keywords.length>0?(u(),g("div",at,[e[38]||(e[38]=o("h5",null,"关键词",-1)),o("div",lt,[(u(!0),g(ee,null,te(r.value.ai_result.keywords,z=>(u(),v(M,{key:z,class:"keyword-tag",size:"small"},{default:s(()=>[m(p(z),1)]),_:2},1024))),128))])])):w("",!0),o("div",st,[o("span",ot," 处理时间: "+p((t=r.value.ai_result.processing_time)==null?void 0:t.toFixed(2))+"秒 ",1)])])])):w("",!0)])):w("",!0)]}),_:1},8,["modelValue"])])}}},pt=Re(nt,[["__scopeId","data-v-d8d583e5"]]);export{pt as default};
