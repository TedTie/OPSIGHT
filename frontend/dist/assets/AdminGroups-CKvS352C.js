import{a as pe,r as i,L as R,o as me,l as Q,f as c,g as l,w as a,b as u,P as g,E as o,Q as ce,e as f,U as X,h as d,X as fe,Y as ve,k as n,d as _,t as F,m as U,V as Y,F as ge,n as _e,y as H}from"./index-g0Sg6k74.js";import{a as be}from"./date-CxVpZo2G.js";import{g as ye,f as we}from"./auth-CVLHtVZ3.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ke={class:"page-container"},xe={class:"card-header"},Ce={class:"table-toolbar"},ze={class:"table-filters"},$e={class:"table-actions"},Ue={class:"pagination-container"},he={class:"members-toolbar"},Se={__name:"AdminGroups",setup(Ae){const x=pe(),h=i(!1),S=i(!1),y=i(!1),N=i([]),A=i([]),j=i([]),w=i(!1),B=i(!1),C=i(!1),z=i(!1),M=i(),V=i(null),$=i([]),D=R({search:""}),v=R({page:1,size:20,total:0}),p=R({name:"",description:""}),J={name:[{required:!0,message:"请输入组织名称",trigger:"blur"},{min:2,max:100,message:"组织名称长度在 2 到 100 个字符",trigger:"blur"}]},k=async()=>{h.value=!0;try{const s={page:v.page,size:v.size,search:D.search},e=await g.get("/groups",{params:s});N.value=e.data.items||[],v.total=e.data.total||0}catch{o.error("获取组织列表失败")}finally{h.value=!1}},K=()=>{z.value=!1,Z(),w.value=!0},W=s=>{z.value=!0,Object.assign(p,{id:parseInt(s.id),name:s.name,description:s.description}),w.value=!0},Z=()=>{var s;Object.assign(p,{id:"",name:"",description:""}),(s=M.value)==null||s.clearValidate()},ee=async()=>{var s;try{await M.value.validate(),y.value=!0,z.value?(await g.put(`/groups/${p.id}`,p),o.success("更新成功")):(await g.post("/groups",p),o.success("创建成功")),w.value=!1,k()}catch(e){((s=e.response)==null?void 0:s.status)===422?o.error("数据验证失败，请检查输入"):o.error(z.value?"更新失败":"创建失败")}finally{y.value=!1}},te=async s=>{try{await H.confirm(`确定要删除组织 ${s.name} 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await g.delete(`/groups/${parseInt(s.id)}`),o.success("删除成功"),k()}catch(e){e!=="cancel"&&o.error("删除失败")}},ae=async s=>{V.value=s,B.value=!0,await G(parseInt(s.id))},G=async s=>{S.value=!0;try{const e=await g.get(`/groups/${s}/members`);A.value=e.data||[]}catch{o.error("获取成员列表失败")}finally{S.value=!1}},le=async()=>{try{const e=(await g.get("/users",{params:{size:1e3}})).data.items||[],r=A.value.map(b=>b.id);j.value=e.filter(b=>!r.includes(b.id)),$.value=[],C.value=!0}catch{o.error("获取用户列表失败")}},se=async()=>{if($.value.length===0){o.warning("请选择要添加的用户");return}y.value=!0;try{await g.post(`/groups/${V.value.id}/members`,{user_ids:$.value}),o.success("添加成功"),C.value=!1,G(V.value.id)}catch{o.error("添加失败")}finally{y.value=!1}},oe=async s=>{try{await H.confirm(`确定要将 ${s.username} 从组织中移除吗？`,"确认移除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await g.delete(`/groups/${V.value.id}/members/${s.id}`),o.success("移除成功"),G(V.value.id)}catch(e){e!=="cancel"&&o.error("移除失败")}};return me(()=>{k()}),(s,e)=>{var q;const r=u("el-button"),b=u("el-input"),m=u("el-table-column"),L=u("el-table"),ne=u("el-pagination"),re=u("el-card"),T=u("el-form-item"),O=u("el-form"),E=u("el-dialog"),ie=u("el-tag"),ue=u("el-option"),de=u("el-select"),P=ce("loading");return f(),Q("div",ke,[e[23]||(e[23]=c("div",{class:"page-header"},[c("h1",{class:"page-title"},"组织管理"),c("p",{class:"page-description"},"管理组织架构和成员")],-1)),l(re,{class:"content-card"},{header:a(()=>[c("div",xe,[e[12]||(e[12]=c("span",null,"组织列表",-1)),d(x).isSuperAdmin?(f(),_(r,{key:0,type:"primary",icon:d(Y),onClick:K},{default:a(()=>[...e[11]||(e[11]=[n(" 新增组织 ",-1)])]),_:1},8,["icon"])):U("",!0)])]),default:a(()=>[c("div",Ce,[c("div",ze,[l(b,{modelValue:D.search,"onUpdate:modelValue":e[0]||(e[0]=t=>D.search=t),placeholder:"搜索组织...","prefix-icon":d(fe),clearable:""},null,8,["modelValue","prefix-icon"])]),c("div",$e,[l(r,{icon:d(ve),onClick:k},{default:a(()=>[...e[13]||(e[13]=[n("刷新",-1)])]),_:1},8,["icon"])])]),X((f(),_(L,{data:N.value,stripe:"",style:{width:"100%"}},{default:a(()=>[l(m,{prop:"name",label:"组织名称","min-width":"200"}),l(m,{prop:"description",label:"描述","min-width":"300"}),l(m,{label:"成员数量",width:"120"},{default:a(({row:t})=>[n(F(t.member_count||0),1)]),_:1}),l(m,{prop:"created_at",label:"创建时间",width:"180"},{default:a(({row:t})=>[n(F(d(be)(t.created_at)),1)]),_:1}),l(m,{label:"操作",width:"200",fixed:"right"},{default:a(({row:t})=>[l(r,{type:"text",size:"small",onClick:I=>ae(t)},{default:a(()=>[...e[14]||(e[14]=[n(" 成员 ",-1)])]),_:1},8,["onClick"]),d(x).isSuperAdmin?(f(),_(r,{key:0,type:"text",size:"small",onClick:I=>W(t)},{default:a(()=>[...e[15]||(e[15]=[n(" 编辑 ",-1)])]),_:1},8,["onClick"])):U("",!0),d(x).isSuperAdmin?(f(),_(r,{key:1,type:"text",size:"small",onClick:I=>te(t)},{default:a(()=>[...e[16]||(e[16]=[n(" 删除 ",-1)])]),_:1},8,["onClick"])):U("",!0)]),_:1})]),_:1},8,["data"])),[[P,h.value]]),c("div",Ue,[l(ne,{"current-page":v.page,"onUpdate:currentPage":e[1]||(e[1]=t=>v.page=t),"page-size":v.size,"onUpdate:pageSize":e[2]||(e[2]=t=>v.size=t),total:v.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:k,onCurrentChange:k},null,8,["current-page","page-size","total"])])]),_:1}),l(E,{modelValue:w.value,"onUpdate:modelValue":e[6]||(e[6]=t=>w.value=t),title:z.value?"编辑组织":"新增组织",width:"500px"},{footer:a(()=>[l(r,{onClick:e[5]||(e[5]=t=>w.value=!1)},{default:a(()=>[...e[17]||(e[17]=[n("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:ee,loading:y.value},{default:a(()=>[...e[18]||(e[18]=[n(" 确定 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(O,{ref_key:"formRef",ref:M,model:p,rules:J,"label-width":"80px"},{default:a(()=>[l(T,{label:"组织名称",prop:"name"},{default:a(()=>[l(b,{modelValue:p.name,"onUpdate:modelValue":e[3]||(e[3]=t=>p.name=t)},null,8,["modelValue"])]),_:1}),l(T,{label:"描述",prop:"description"},{default:a(()=>[l(b,{modelValue:p.description,"onUpdate:modelValue":e[4]||(e[4]=t=>p.description=t),type:"textarea",rows:3,placeholder:"请输入组织描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(E,{modelValue:B.value,"onUpdate:modelValue":e[7]||(e[7]=t=>B.value=t),title:`${(q=V.value)==null?void 0:q.name} - 成员管理`,width:"800px"},{default:a(()=>[c("div",he,[d(x).isSuperAdmin?(f(),_(r,{key:0,type:"primary",icon:d(Y),onClick:le},{default:a(()=>[...e[19]||(e[19]=[n(" 添加成员 ",-1)])]),_:1},8,["icon"])):U("",!0)]),X((f(),_(L,{data:A.value,stripe:"",style:{width:"100%"}},{default:a(()=>[l(m,{prop:"username",label:"用户名",width:"150"}),l(m,{prop:"full_name",label:"姓名",width:"120"}),l(m,{prop:"email",label:"邮箱","min-width":"200"}),l(m,{label:"角色",width:"120"},{default:a(({row:t})=>[l(ie,{type:d(ye)(t.role),size:"small"},{default:a(()=>[n(F(d(we)(t.role)),1)]),_:2},1032,["type"])]),_:1}),l(m,{label:"操作",width:"100"},{default:a(({row:t})=>[d(x).isSuperAdmin?(f(),_(r,{key:0,type:"text",size:"small",onClick:I=>oe(t)},{default:a(()=>[...e[20]||(e[20]=[n(" 移除 ",-1)])]),_:1},8,["onClick"])):U("",!0)]),_:1})]),_:1},8,["data"])),[[P,S.value]])]),_:1},8,["modelValue","title"]),l(E,{modelValue:C.value,"onUpdate:modelValue":e[10]||(e[10]=t=>C.value=t),title:"添加成员",width:"500px"},{footer:a(()=>[l(r,{onClick:e[9]||(e[9]=t=>C.value=!1)},{default:a(()=>[...e[21]||(e[21]=[n("取消",-1)])]),_:1}),l(r,{type:"primary",onClick:se,loading:y.value},{default:a(()=>[...e[22]||(e[22]=[n(" 确定 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(O,{"label-width":"80px"},{default:a(()=>[l(T,{label:"选择用户"},{default:a(()=>[l(de,{modelValue:$.value,"onUpdate:modelValue":e[8]||(e[8]=t=>$.value=t),multiple:"",filterable:"",placeholder:"请选择用户",style:{width:"100%"}},{default:a(()=>[(f(!0),Q(ge,null,_e(j.value,t=>(f(),_(ue,{key:t.id,label:`${t.username} (${t.full_name})`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Te=Ve(Se,[["__scopeId","data-v-85758352"]]);export{Te as default};
