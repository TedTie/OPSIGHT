import{P as ee}from"./plus-QCcyPRoI.js";import{S as le}from"./search-BJMowTUF.js";import{R as ae}from"./refresh-D2P9cjYi.js";import{a as te}from"./date-qiPTsFx8.js";import{g as oe,f as se}from"./auth-pcDRQd-v.js";import{_ as re,e as V,C as j,f as ne,c as S,a as f,k as a,j as t,h as i,x as U,E as _,A as ie,o as u,B as de,l as x,p,i as y,t as C,q as E,F as ue,r as pe,y as A}from"./index-B9ntIOOh.js";const me={class:"page-container"},fe={class:"card-header"},_e={class:"table-toolbar"},ce={class:"table-filters"},ge={class:"table-actions"},ve={key:1,class:"text-gray-400"},ye={key:1,class:"text-gray-400"},we={class:"pagination-container"},be={__name:"AdminUsers",setup(Ve){const D=o=>({cc:"CC(顾问)",ss:"SS(班主任)",lp:"LP(英文辅导)",sa:"SA(超级分析师)"})[o]||o,B=V(!1),$=V(!1),N=V([]),P=V([]),z=V(!1),d=V(!1),R=V(),w=j({search:"",role:"",is_active:""}),c=j({page:1,size:20,total:0}),s=j({username:"",organization:"",role:"user",identity_type:null,group_id:null,is_active:!0,password:"",confirm_password:""}),F={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:50,message:"用户名长度在 3 到 50 个字符",trigger:"blur"}],role:[{required:!0,message:"请选择权限",trigger:"change"}],password:[{validator:(o,e,r)=>d.value?e&&String(e).length<6?r(new Error("密码至少6位")):r():!e||String(e).length<6?r(new Error("密码至少6位")):r(),trigger:"blur"}],confirm_password:[{validator:(o,e,r)=>d.value?s.password&&e!==s.password?r(new Error("两次输入的密码不一致")):r():e?e!==s.password?r(new Error("两次输入的密码不一致")):r():r(new Error("请再次输入密码")),trigger:"blur"}]},b=async()=>{B.value=!0;try{const o=Object.fromEntries(Object.entries(w).filter(([g,n])=>n!==""&&n!=null)),e={page:c.page,size:c.size,...o},r=await U.get("/users",{params:e});N.value=r.data.items||[],c.total=r.data.total||0}catch{_.error("获取用户列表失败")}finally{B.value=!1}},O=async()=>{try{const o=await U.get("/groups");P.value=o.data.items||[]}catch(o){console.error("获取组别列表失败:",o)}},q=()=>{d.value=!1,M(),z.value=!0},L=o=>{d.value=!0,Object.assign(s,{id:o.id,username:o.username,organization:o.organization||"",role:o.role||"user",identity_type:o.identity_type||null,group_id:o.group_id||null,is_active:o.is_active,password:"",confirm_password:""}),z.value=!0},M=()=>{var o;Object.assign(s,{id:"",username:"",organization:"",role:"user",identity_type:null,group_id:null,is_active:!0,password:"",confirm_password:""}),(o=R.value)==null||o.clearValidate()},I=async()=>{var o;try{if(await R.value.validate(),$.value=!0,d.value){const e={...s};e.password||delete e.password,delete e.confirm_password,await U.put(`/users/${s.id}`,e),_.success("更新成功")}else{const e={...s};delete e.confirm_password,await U.post("/users",e),_.success("创建成功")}z.value=!1,b()}catch(e){((o=e.response)==null?void 0:o.status)===422?_.error("数据验证失败，请检查输入"):_.error(d.value?"更新失败":"创建失败")}finally{$.value=!1}},G=async o=>{try{await A.confirm(`确定要${o.is_active?"禁用":"启用"}用户 ${o.username} 吗？`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await U.put(`/users/${o.id}`,{...o,is_active:!o.is_active}),_.success("操作成功"),b()}catch(e){e!=="cancel"&&_.error("操作失败")}},H=async o=>{try{await A.confirm(`确定要删除用户 ${o.username} 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await U.delete(`/users/${o.id}`),_.success("删除成功"),b()}catch(e){e!=="cancel"&&_.error("删除失败")}};return ne(()=>{b(),O()}),(o,e)=>{const r=i("el-button"),g=i("el-input"),n=i("el-option"),k=i("el-select"),v=i("el-table-column"),h=i("el-tag"),J=i("el-table"),K=i("el-pagination"),Q=i("el-card"),m=i("el-form-item"),W=i("el-switch"),X=i("el-form"),Y=i("el-dialog"),Z=ie("loading");return u(),S("div",me,[e[24]||(e[24]=f("div",{class:"page-header"},[f("h1",{class:"page-title"},"用户管理"),f("p",{class:"page-description"},"管理系统用户和权限")],-1)),a(Q,{class:"content-card"},{header:t(()=>[f("div",fe,[e[18]||(e[18]=f("span",null,"用户列表",-1)),a(r,{type:"primary",icon:x(ee),onClick:q},{default:t(()=>[...e[17]||(e[17]=[p(" 新增用户 ",-1)])]),_:1},8,["icon"])])]),default:t(()=>[f("div",_e,[f("div",ce,[a(g,{modelValue:w.search,"onUpdate:modelValue":e[0]||(e[0]=l=>w.search=l),placeholder:"搜索用户...","prefix-icon":x(le),clearable:""},null,8,["modelValue","prefix-icon"]),a(k,{modelValue:w.role,"onUpdate:modelValue":e[1]||(e[1]=l=>w.role=l),placeholder:"角色筛选",clearable:""},{default:t(()=>[a(n,{label:"普通用户",value:"user"}),a(n,{label:"管理员",value:"admin"}),a(n,{label:"超级管理员",value:"super_admin"})]),_:1},8,["modelValue"]),a(k,{modelValue:w.is_active,"onUpdate:modelValue":e[2]||(e[2]=l=>w.is_active=l),placeholder:"状态筛选",clearable:""},{default:t(()=>[a(n,{label:"启用",value:!0}),a(n,{label:"禁用",value:!1})]),_:1},8,["modelValue"])]),f("div",ge,[a(r,{icon:x(ae),onClick:b},{default:t(()=>[...e[19]||(e[19]=[p("刷新",-1)])]),_:1},8,["icon"])])]),de((u(),y(J,{data:N.value,stripe:"",style:{width:"100%"}},{default:t(()=>[a(v,{prop:"username",label:"用户名",width:"120"}),a(v,{prop:"organization",label:"组织","min-width":"180"}),a(v,{label:"权限",width:"100"},{default:t(({row:l})=>[a(h,{type:x(oe)(l.role),size:"small"},{default:t(()=>[p(C(x(se)(l.role)),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"身份",width:"120"},{default:t(({row:l})=>[l.identity_type?(u(),y(h,{key:0,type:"info",size:"small"},{default:t(()=>[p(C(D(l.identity_type)),1)]),_:2},1024)):(u(),S("span",ve,"-"))]),_:1}),a(v,{label:"组别",width:"120"},{default:t(({row:l})=>[l.group_name?(u(),y(h,{key:0,type:"primary",size:"small"},{default:t(()=>[p(C(l.group_name),1)]),_:2},1024)):(u(),S("span",ye,"-"))]),_:1}),a(v,{label:"状态",width:"80"},{default:t(({row:l})=>[a(h,{type:l.is_active?"success":"danger",size:"small"},{default:t(()=>[p(C(l.is_active?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(v,{prop:"created_at",label:"创建时间",width:"180"},{default:t(({row:l})=>[p(C(x(te)(l.created_at)),1)]),_:1}),a(v,{label:"操作",width:"200",fixed:"right"},{default:t(({row:l})=>[a(r,{type:"text",size:"small",onClick:T=>L(l)},{default:t(()=>[...e[20]||(e[20]=[p(" 编辑 ",-1)])]),_:1},8,["onClick"]),a(r,{type:"text",size:"small",onClick:T=>G(l),disabled:l.role==="super_admin"},{default:t(()=>[p(C(l.is_active?"禁用":"启用"),1)]),_:2},1032,["onClick","disabled"]),a(r,{type:"text",size:"small",onClick:T=>H(l),disabled:l.role==="super_admin"},{default:t(()=>[...e[21]||(e[21]=[p(" 删除 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[Z,B.value]]),f("div",we,[a(K,{"current-page":c.page,"onUpdate:currentPage":e[3]||(e[3]=l=>c.page=l),"page-size":c.size,"onUpdate:pageSize":e[4]||(e[4]=l=>c.size=l),total:c.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:b,onCurrentChange:b},null,8,["current-page","page-size","total"])])]),_:1}),a(Y,{modelValue:z.value,"onUpdate:modelValue":e[16]||(e[16]=l=>z.value=l),title:d.value?"编辑用户":"新增用户",width:"500px"},{footer:t(()=>[a(r,{onClick:e[15]||(e[15]=l=>z.value=!1)},{default:t(()=>[...e[22]||(e[22]=[p("取消",-1)])]),_:1}),a(r,{type:"primary",onClick:I,loading:$.value},{default:t(()=>[...e[23]||(e[23]=[p(" 确定 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[a(X,{ref_key:"formRef",ref:R,model:s,rules:F,"label-width":"80px"},{default:t(()=>[a(m,{label:"用户名",prop:"username"},{default:t(()=>[a(g,{modelValue:s.username,"onUpdate:modelValue":e[5]||(e[5]=l=>s.username=l),disabled:d.value},null,8,["modelValue","disabled"])]),_:1}),a(m,{label:"组织",prop:"organization"},{default:t(()=>[a(g,{modelValue:s.organization,"onUpdate:modelValue":e[6]||(e[6]=l=>s.organization=l),placeholder:"请输入组织名称"},null,8,["modelValue"])]),_:1}),a(m,{label:"权限",prop:"role"},{default:t(()=>[a(k,{modelValue:s.role,"onUpdate:modelValue":e[7]||(e[7]=l=>s.role=l),style:{width:"100%"}},{default:t(()=>[a(n,{label:"普通用户",value:"user"}),a(n,{label:"管理员",value:"admin"}),a(n,{label:"超级管理员",value:"super_admin"})]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"身份",prop:"identity_type"},{default:t(()=>[a(k,{modelValue:s.identity_type,"onUpdate:modelValue":e[8]||(e[8]=l=>s.identity_type=l),style:{width:"100%"},clearable:""},{default:t(()=>[a(n,{label:"CC(顾问)",value:"cc"}),a(n,{label:"SS(班主任)",value:"ss"}),a(n,{label:"LP(英文辅导)",value:"lp"}),a(n,{label:"SA(超级分析师)",value:"sa"})]),_:1},8,["modelValue"])]),_:1}),d.value?E("",!0):(u(),y(m,{key:0,label:"初始密码",prop:"password"},{default:t(()=>[a(g,{modelValue:s.password,"onUpdate:modelValue":e[9]||(e[9]=l=>s.password=l),type:"password",placeholder:"请输入至少6位密码","show-password":""},null,8,["modelValue"])]),_:1})),d.value?E("",!0):(u(),y(m,{key:1,label:"确认密码",prop:"confirm_password"},{default:t(()=>[a(g,{modelValue:s.confirm_password,"onUpdate:modelValue":e[10]||(e[10]=l=>s.confirm_password=l),type:"password",placeholder:"请再次输入","show-password":""},null,8,["modelValue"])]),_:1})),d.value?(u(),y(m,{key:2,label:"新密码",prop:"password"},{default:t(()=>[a(g,{modelValue:s.password,"onUpdate:modelValue":e[11]||(e[11]=l=>s.password=l),type:"password",placeholder:"留空则不修改","show-password":""},null,8,["modelValue"])]),_:1})):E("",!0),d.value?(u(),y(m,{key:3,label:"确认密码",prop:"confirm_password"},{default:t(()=>[a(g,{modelValue:s.confirm_password,"onUpdate:modelValue":e[12]||(e[12]=l=>s.confirm_password=l),type:"password",placeholder:"请再次输入","show-password":""},null,8,["modelValue"])]),_:1})):E("",!0),a(m,{label:"组别",prop:"group_id"},{default:t(()=>[a(k,{modelValue:s.group_id,"onUpdate:modelValue":e[13]||(e[13]=l=>s.group_id=l),style:{width:"100%"},clearable:"",placeholder:"请选择组别"},{default:t(()=>[(u(!0),S(ue,null,pe(P.value,l=>(u(),y(n,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"状态"},{default:t(()=>[a(W,{modelValue:s.is_active,"onUpdate:modelValue":e[14]||(e[14]=l=>s.is_active=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Se=re(be,[["__scopeId","data-v-4da1ff97"]]);export{Se as default};
