import{P as H}from"./plus-QCcyPRoI.js";import{S as pe}from"./search-BJMowTUF.js";import{R as me}from"./refresh-D2P9cjYi.js";import{a as ce}from"./date-qiPTsFx8.js";import{g as fe,f as ve}from"./auth-pcDRQd-v.js";import{_ as ge,d as ye,e as i,C as I,f as be,c as J,a as c,k as l,j as a,h as u,x as g,E as r,A as _e,o as f,B as K,l as d,p as n,i as y,t as j,q as A,F as we,r as Ve,y as Q}from"./index-B9ntIOOh.js";const ke={class:"page-container"},xe={class:"card-header"},Ce={class:"table-toolbar"},ze={class:"table-filters"},$e={class:"table-actions"},Ae={class:"pagination-container"},Ue={class:"members-toolbar"},he={__name:"AdminGroups",setup(Se){const x=ye(),U=i(!1),h=i(!1),_=i(!1),F=i([]),S=i([]),N=i([]),w=i(!1),B=i(!1),C=i(!1),z=i(!1),M=i(),V=i(null),$=i([]),D=I({search:""}),v=I({page:1,size:20,total:0}),p=I({name:"",description:""}),W={name:[{required:!0,message:"请输入组织名称",trigger:"blur"},{min:2,max:100,message:"组织名称长度在 2 到 100 个字符",trigger:"blur"}]},k=async()=>{U.value=!0;try{const o={page:v.page,size:v.size,search:D.search},s=(await g.get("/groups",{params:o})).data||[];F.value=s.items&&Array.isArray(s.items)?s.items:Array.isArray(s)?s:[],v.total=typeof s.total=="number"?s.total:Array.isArray(s)?s.length:0}catch{r.error("获取组织列表失败")}finally{U.value=!1}},X=()=>{z.value=!1,Z(),w.value=!0},Y=o=>{z.value=!0,Object.assign(p,{id:parseInt(o.id),name:o.name,description:o.description}),w.value=!0},Z=()=>{var o;Object.assign(p,{id:"",name:"",description:""}),(o=M.value)==null||o.clearValidate()},ee=async()=>{var o;try{await M.value.validate(),_.value=!0,z.value?(await g.put(`/groups/${p.id}`,p),r.success("更新成功")):(await g.post("/groups",p),r.success("创建成功")),w.value=!1,k()}catch(e){((o=e.response)==null?void 0:o.status)===422?r.error("数据验证失败，请检查输入"):r.error(z.value?"更新失败":"创建失败")}finally{_.value=!1}},te=async o=>{try{await Q.confirm(`确定要删除组织 ${o.name} 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await g.delete(`/groups/${parseInt(o.id)}`),r.success("删除成功"),k()}catch(e){e!=="cancel"&&r.error("删除失败")}},ae=async o=>{V.value=o,B.value=!0,await R(parseInt(o.id))},R=async o=>{h.value=!0;try{const e=await g.get(`/groups/${o}/members`);S.value=e.data||[]}catch{r.error("获取成员列表失败")}finally{h.value=!1}},le=async()=>{try{const e=(await g.get("/users",{params:{size:1e3}})).data.items||[],s=S.value.map(b=>b.id);N.value=e.filter(b=>!s.includes(b.id)),$.value=[],C.value=!0}catch{r.error("获取用户列表失败")}},oe=async()=>{if($.value.length===0){r.warning("请选择要添加的用户");return}_.value=!0;try{await g.post(`/groups/${V.value.id}/members`,{user_ids:$.value}),r.success("添加成功"),C.value=!1,R(V.value.id)}catch{r.error("添加失败")}finally{_.value=!1}},se=async o=>{try{await Q.confirm(`确定要将 ${o.username} 从组织中移除吗？`,"确认移除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await g.delete(`/groups/${V.value.id}/members/${o.id}`),r.success("移除成功"),R(V.value.id)}catch(e){e!=="cancel"&&r.error("移除失败")}};return be(()=>{k()}),(o,e)=>{var O;const s=u("el-button"),b=u("el-input"),m=u("el-table-column"),P=u("el-table"),re=u("el-pagination"),ne=u("el-card"),G=u("el-form-item"),q=u("el-form"),T=u("el-dialog"),ie=u("el-tag"),ue=u("el-option"),de=u("el-select"),L=_e("loading");return f(),J("div",ke,[e[23]||(e[23]=c("div",{class:"page-header"},[c("h1",{class:"page-title"},"组织管理"),c("p",{class:"page-description"},"管理组织架构和成员")],-1)),l(ne,{class:"content-card"},{header:a(()=>[c("div",xe,[e[12]||(e[12]=c("span",null,"组织列表",-1)),d(x).isSuperAdmin?(f(),y(s,{key:0,type:"primary",icon:d(H),onClick:X},{default:a(()=>[...e[11]||(e[11]=[n(" 新增组织 ",-1)])]),_:1},8,["icon"])):A("",!0)])]),default:a(()=>[c("div",Ce,[c("div",ze,[l(b,{modelValue:D.search,"onUpdate:modelValue":e[0]||(e[0]=t=>D.search=t),placeholder:"搜索组织...","prefix-icon":d(pe),clearable:""},null,8,["modelValue","prefix-icon"])]),c("div",$e,[l(s,{icon:d(me),onClick:k},{default:a(()=>[...e[13]||(e[13]=[n("刷新",-1)])]),_:1},8,["icon"])])]),K((f(),y(P,{data:F.value,stripe:"",style:{width:"100%"}},{default:a(()=>[l(m,{prop:"name",label:"组织名称","min-width":"200"}),l(m,{prop:"description",label:"描述","min-width":"300"}),l(m,{label:"成员数量",width:"120"},{default:a(({row:t})=>[n(j(t.member_count||0),1)]),_:1}),l(m,{prop:"created_at",label:"创建时间",width:"180"},{default:a(({row:t})=>[n(j(d(ce)(t.created_at)),1)]),_:1}),l(m,{label:"操作",width:"200",fixed:"right"},{default:a(({row:t})=>[l(s,{type:"text",size:"small",onClick:E=>ae(t)},{default:a(()=>[...e[14]||(e[14]=[n(" 成员 ",-1)])]),_:1},8,["onClick"]),d(x).isSuperAdmin?(f(),y(s,{key:0,type:"text",size:"small",onClick:E=>Y(t)},{default:a(()=>[...e[15]||(e[15]=[n(" 编辑 ",-1)])]),_:1},8,["onClick"])):A("",!0),d(x).isSuperAdmin?(f(),y(s,{key:1,type:"text",size:"small",onClick:E=>te(t)},{default:a(()=>[...e[16]||(e[16]=[n(" 删除 ",-1)])]),_:1},8,["onClick"])):A("",!0)]),_:1})]),_:1},8,["data"])),[[L,U.value]]),c("div",Ae,[l(re,{"current-page":v.page,"onUpdate:currentPage":e[1]||(e[1]=t=>v.page=t),"page-size":v.size,"onUpdate:pageSize":e[2]||(e[2]=t=>v.size=t),total:v.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:k,onCurrentChange:k},null,8,["current-page","page-size","total"])])]),_:1}),l(T,{modelValue:w.value,"onUpdate:modelValue":e[6]||(e[6]=t=>w.value=t),title:z.value?"编辑组织":"新增组织",width:"500px"},{footer:a(()=>[l(s,{onClick:e[5]||(e[5]=t=>w.value=!1)},{default:a(()=>[...e[17]||(e[17]=[n("取消",-1)])]),_:1}),l(s,{type:"primary",onClick:ee,loading:_.value},{default:a(()=>[...e[18]||(e[18]=[n(" 确定 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(q,{ref_key:"formRef",ref:M,model:p,rules:W,"label-width":"80px"},{default:a(()=>[l(G,{label:"组织名称",prop:"name"},{default:a(()=>[l(b,{modelValue:p.name,"onUpdate:modelValue":e[3]||(e[3]=t=>p.name=t)},null,8,["modelValue"])]),_:1}),l(G,{label:"描述",prop:"description"},{default:a(()=>[l(b,{modelValue:p.description,"onUpdate:modelValue":e[4]||(e[4]=t=>p.description=t),type:"textarea",rows:3,placeholder:"请输入组织描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(T,{modelValue:B.value,"onUpdate:modelValue":e[7]||(e[7]=t=>B.value=t),title:`${(O=V.value)==null?void 0:O.name} - 成员管理`,width:"800px"},{default:a(()=>[c("div",Ue,[d(x).isSuperAdmin?(f(),y(s,{key:0,type:"primary",icon:d(H),onClick:le},{default:a(()=>[...e[19]||(e[19]=[n(" 添加成员 ",-1)])]),_:1},8,["icon"])):A("",!0)]),K((f(),y(P,{data:S.value,stripe:"",style:{width:"100%"}},{default:a(()=>[l(m,{prop:"username",label:"用户名",width:"150"}),l(m,{prop:"full_name",label:"姓名",width:"120"}),l(m,{prop:"email",label:"邮箱","min-width":"200"}),l(m,{label:"角色",width:"120"},{default:a(({row:t})=>[l(ie,{type:d(fe)(t.role),size:"small"},{default:a(()=>[n(j(d(ve)(t.role)),1)]),_:2},1032,["type"])]),_:1}),l(m,{label:"操作",width:"100"},{default:a(({row:t})=>[d(x).isSuperAdmin?(f(),y(s,{key:0,type:"text",size:"small",onClick:E=>se(t)},{default:a(()=>[...e[20]||(e[20]=[n(" 移除 ",-1)])]),_:1},8,["onClick"])):A("",!0)]),_:1})]),_:1},8,["data"])),[[L,h.value]])]),_:1},8,["modelValue","title"]),l(T,{modelValue:C.value,"onUpdate:modelValue":e[10]||(e[10]=t=>C.value=t),title:"添加成员",width:"500px"},{footer:a(()=>[l(s,{onClick:e[9]||(e[9]=t=>C.value=!1)},{default:a(()=>[...e[21]||(e[21]=[n("取消",-1)])]),_:1}),l(s,{type:"primary",onClick:oe,loading:_.value},{default:a(()=>[...e[22]||(e[22]=[n(" 确定 ",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(q,{"label-width":"80px"},{default:a(()=>[l(G,{label:"选择用户"},{default:a(()=>[l(de,{modelValue:$.value,"onUpdate:modelValue":e[8]||(e[8]=t=>$.value=t),multiple:"",filterable:"",placeholder:"请选择用户",style:{width:"100%"}},{default:a(()=>[(f(!0),J(we,null,Ve(N.value,t=>(f(),y(ue,{key:t.id,label:`${t.username} (${t.full_name})`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Ee=ge(he,[["__scopeId","data-v-d75e7e07"]]);export{Ee as default};
