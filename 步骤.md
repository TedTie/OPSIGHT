# KillerApp 部署与操作步骤（Windows，PowerShell）

## 0. 说明与起点
- 根目录即项目文件夹位置：`E:\51\AI\KillerApp`
- 全部命令在 PowerShell 里执行；可直接复制粘贴。

## 1. 打开 PowerShell 并进入仓库根目录
```
cd E:\51\AI\KillerApp
```

## 2. 可选：验证脚本存在
```
dir .\scripts\deploy_supabase.ps1
```

## 3. 安装 Supabase CLI（若未安装）
```
iwr -useb get.scoop.sh | iex
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
scoop install supabase
supabase --version
```

## 4. 获取 Supabase Access Token（在浏览器）
- 打开网址并登录：`https://supabase.com/dashboard/account/tokens`
- 点击 Create new token，复制得到的令牌（形如 `sbp_...`）。

## 5. 一键安全脚本部署（推荐）
```
cd E:\51\AI\KillerApp
# 如果你已经知道自己的 Project Ref，建议显式传入：
powershell -ExecutionPolicy Bypass -File .\scripts\deploy_supabase.ps1 -ProjectRef <你的ProjectRef>
```
- 按提示粘贴令牌（不回显、不写日志）。

> 备注：`ProjectRef` 可在 Supabase 控制台 → 你的项目 → `Project Settings` → `General` 页面找到（形如 `abcd1234xxxxxxxxxxxx`）。

## 6. 验证部署结果
```
supabase functions list
```
- 输出中应当包含 `killerapp`。

## 7. 非交互部署（将令牌只在当前会话临时使用）
```
cd E:\51\AI\KillerApp
$env:SUPABASE_ACCESS_TOKEN = "sbp_在这里粘贴你的令牌"
supabase login --no-browser
supabase link --project-ref <你的ProjectRef>
supabase functions deploy killerapp
Remove-Item Env:SUPABASE_ACCESS_TOKEN
```

## 8. 免安装（使用 npx 临时调用 CLI）
```
cd E:\51\AI\KillerApp
npx supabase login --token sbp_在这里粘贴你的令牌 --no-browser
npx supabase link --project-ref <你的ProjectRef>
npx supabase functions deploy killerapp
```

## 9. 在官网 SQL Editor 执行数据库脚本（如需）
- 访问：`https://supabase.com/dashboard` → 选择你的项目 → `SQL Editor`
- 打开本地文件：`supabase/sql/opsight_schema.sql`
- 将内容粘贴到 SQL Editor，执行。注意脚本中的 `on conflict (name) do nothing` 可确保幂等插入。

## 10. 常见问题与重试
```
supabase --version
supabase logout
supabase link --project-ref <你的ProjectRef>
supabase functions list
```

## 11. 回滚与清理（如需）
```
# 仅退出登录（不影响函数）：
supabase logout

# 删除当前会话令牌变量（若使用了第 7 步）：
Remove-Item Env:SUPABASE_ACCESS_TOKEN
```

## 12. 在 Vercel 设置前端环境变量（让前端指向函数）
- 打开 `https://vercel.com/dashboard` → 选择你的项目 `opsight` → `Settings` → `Environment Variables`。
- 新增或编辑以下两个变量（在 `Production` 与 `Preview` 环境都添加）：
  - `VITE_API_BASE_URL` = `https://hmzwgteftyiwfhepkvco.functions.supabase.co/killerapp/api/v1`
  - `VITE_USE_CREDENTIALS` = `false`
- 为满足 Supabase Edge Functions 的鉴权要求，再添加：
  - `VITE_SUPABASE_ANON_KEY` = `在 Supabase 控制台 Project Settings → API → Project API keys 中的 anon public key`
- 点击保存后，返回项目页选择 `Deployments`，执行 `Redeploy` 或触发一次新的部署。

> 说明：前端使用 Vite，所有以 `VITE_` 开头的变量会在构建时写入。Supabase 函数默认允许跨域（`Access-Control-Allow-Origin: *`），因此不需要携带 Cookie，会话；请务必将 `VITE_USE_CREDENTIALS` 设为 `false`。

## 13. 验证前端是否读取到新的配置
- 打开 `https://opsight.vercel.app/login`。
- 按 `F12` 打开浏览器开发者工具 → `Console`。
- 页面初始化会打印 Axios 配置日志，确认：
  - `baseURL` 为 `https://hmzwgteftyiwfhepkvco.functions.supabase.co/killerapp/api/v1`
  - `withCredentials` 为 `false`
  - `hasAuthHeader` 为 `true`（表示已注入 `Authorization: Bearer <anon-key>`）

## 14. 登录功能测试
- 在登录页输入：
  - 用户名：`admin`
  - 密码：`51talk2025`
- 点击 `登录`，应显示“登录成功”，并进入系统首页。

## 15. 若仍失败，快速排查
- 访问函数登录接口测试：
  - `POST https://<你的ProjectRef>.functions.supabase.co/killerapp/api/v1/auth/login`
  - Body：`{"username":"admin","password":"51talk2025"}`
  - 返回 `200` 且包含 `user` 字段表示函数正常。
- 若返回 `Requested function was not found`：说明函数未成功部署或 `ProjectRef` 填错；请重做第 5–8 步。
- 若前端仍提示 404：检查第 12 步是否正确设置 `VITE_API_BASE_URL` 并重新部署。
- 若命令行或浏览器显示 401 Unauthorized：缺少 `Authorization: Bearer <anon-key>` 头；请确保在 Vercel 环境变量中配置了 `VITE_SUPABASE_ANON_KEY`，并已重新部署。